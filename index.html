<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AP Student Support Portal - ACS (A)</title>
    <script src="https://res.cdn.office.net/teams-js/2.0.0/js/MicrosoftTeams.min.js"></script>
    <style>
        /* Fluent UI Design System */
        :root {
            /* Fluent UI Colors */
            --colorNeutralBackground1: #ffffff;
            --colorNeutralBackground2: #faf9f8;
            --colorNeutralBackground3: #f3f2f1;
            --colorNeutralForeground1: #323130;
            --colorNeutralForeground2: #605e5c;
            --colorNeutralForeground3: #8a8886;
            --colorNeutralStroke1: #edebe9;
            --colorNeutralStroke2: #e1dfdd;
            
            /* Brand Colors */
            --colorBrandBackground: rgb(51, 65, 85);
            --colorBrandForeground: #ffffff;
            --colorAccent: rgb(255, 197, 38);
            --colorAccentHover: rgb(255, 187, 20);
            --colorError: rgb(172, 0, 39);
            --colorSuccess: #107c10;
            
            /* Spacing (4px base unit) */
            --spacing-xs: 4px;
            --spacing-s: 8px;
            --spacing-m: 16px;
            --spacing-l: 24px;
            --spacing-xl: 32px;
            --spacing-xxl: 40px;
            
            /* Typography */
            --fontFamilyBase: 'Segoe UI', 'Segoe UI Web (West European)', -apple-system, BlinkMacSystemFont, 'Roboto', 'Helvetica Neue', sans-serif;
            --fontSizeBase: 14px;
            --fontSizeSmall: 12px;
            --fontSizeMedium: 16px;
            --fontSizeLarge: 20px;
            --fontSizeXLarge: 24px;
            --fontSizeXXLarge: 28px;
            --fontWeightRegular: 400;
            --fontWeightSemibold: 600;
            --fontWeightBold: 700;
            
            /* Shadows */
            --shadow2: 0 1.6px 3.6px rgba(0, 0, 0, 0.13), 0 0.3px 0.9px rgba(0, 0, 0, 0.11);
            --shadow4: 0 3.2px 7.2px rgba(0, 0, 0, 0.13), 0 0.6px 1.8px rgba(0, 0, 0, 0.11);
            --shadow8: 0 6.4px 14.4px rgba(0, 0, 0, 0.13), 0 1.2px 3.6px rgba(0, 0, 0, 0.11);
            --shadow16: 0 12.8px 28.8px rgba(0, 0, 0, 0.13), 0 2.4px 7.2px rgba(0, 0, 0, 0.11);
            
            /* Border Radius */
            --radiusSmall: 2px;
            --radiusMedium: 4px;
            --radiusLarge: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--fontFamilyBase);
            font-size: var(--fontSizeBase);
            font-weight: var(--fontWeightRegular);
            background: var(--colorNeutralBackground2);
            color: var(--colorNeutralForeground1);
            min-height: 100vh;
            padding: 0;
            line-height: 1.5;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--colorNeutralBackground1);
            min-height: 100vh;
            box-shadow: var(--shadow4);
        }

        .header {
            background: var(--colorBrandBackground);
            color: var(--colorBrandForeground);
            padding: var(--spacing-l) var(--spacing-xl);
            box-shadow: var(--shadow2);
        }

        .header h1 {
            font-size: var(--fontSizeXXLarge);
            font-weight: var(--fontWeightSemibold);
            margin-bottom: var(--spacing-xs);
            line-height: 1.2;
        }

        .header .subtitle {
            font-size: var(--fontSizeBase);
            opacity: 0.9;
            font-weight: var(--fontWeightRegular);
        }

        .nav-tabs {
            display: flex;
            gap: var(--spacing-s);
            padding: var(--spacing-m) var(--spacing-xl);
            background: var(--colorNeutralBackground1);
            border-bottom: 1px solid var(--colorNeutralStroke2);
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: var(--spacing-s) var(--spacing-l);
            background: var(--colorNeutralBackground3);
            border: none;
            border-radius: var(--radiusMedium);
            font-size: var(--fontSizeBase);
            font-weight: var(--fontWeightSemibold);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--colorNeutralForeground1);
            min-height: 32px;
        }

        .nav-tab:hover {
            background: var(--colorNeutralStroke1);
        }

        .nav-tab.active {
            background: var(--colorBrandBackground);
            color: var(--colorBrandForeground);
        }

        .view-container {
            display: none;
            padding: var(--spacing-xl);
        }

        .view-container.active {
            display: block;
        }

        #homeView {
            padding-top: var(--spacing-m);
        }

        @media (max-width: 768px) {
            .header {
                padding: var(--spacing-m) var(--spacing-l);
            }
            
            .header h1 {
                font-size: var(--fontSizeXLarge);
            }
            
            .nav-tabs {
                padding: var(--spacing-m);
                gap: var(--spacing-xs);
            }
            
            .nav-tab {
                padding: var(--spacing-xs) var(--spacing-m);
                font-size: var(--fontSizeSmall);
            }
            
            .view-container {
                padding: var(--spacing-m);
            }
        }

        .main-menu {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: var(--spacing-l);
            margin-top: var(--spacing-s);
        }

        .menu-card {
            border-radius: var(--radiusLarge);
            padding: var(--spacing-xl);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow4);
            border: none;
        }

        .menu-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow8);
        }

        @media (max-width: 768px) {
            .main-menu {
                grid-template-columns: 1fr;
                gap: var(--spacing-m);
            }
            
            .menu-card {
                padding: var(--spacing-l);
            }
        }

        .menu-card.menu-card-yellow {
            background: rgb(255, 197, 38);
        }

        .menu-card.menu-card-blue {
            background: rgb(51, 65, 85);
        }

        .menu-card.menu-card-red {
            background: rgb(172, 0, 39);
        }

        .menu-card h2 {
            margin-bottom: var(--spacing-s);
            font-size: var(--fontSizeLarge);
            font-weight: var(--fontWeightSemibold);
            line-height: 1.3;
        }

        .menu-card.menu-card-yellow h2,
        .menu-card.menu-card-yellow p {
            color: rgb(51, 65, 85);
        }

        .menu-card.menu-card-blue h2,
        .menu-card.menu-card-blue p {
            color: white;
        }

        .menu-card.menu-card-red h2,
        .menu-card.menu-card-red p {
            color: white;
        }

        .menu-card p {
            margin-bottom: 0;
            font-size: var(--fontSizeSmall);
            line-height: 1.4;
        }

        .menu-card-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto var(--spacing-s);
            fill: none;
            stroke-width: 1.5;
        }

        @media (max-width: 768px) {
            .menu-card-icon {
                width: 40px;
                height: 40px;
            }
            
            .menu-card h2 {
                font-size: var(--fontSizeMedium);
            }
        }

        .menu-card-icon svg {
            width: 100%;
            height: 100%;
        }

        .menu-card.menu-card-yellow .menu-card-icon {
            stroke: rgb(51, 65, 85);
        }

        .menu-card.menu-card-blue .menu-card-icon {
            stroke: white;
        }

        .menu-card.menu-card-blue .menu-card-icon svg {
            stroke: white !important;
        }

        .menu-card.menu-card-red .menu-card-icon {
            stroke: white;
        }

        .menu-card.menu-card-red .menu-card-icon svg {
            stroke: white !important;
        }

        .status {
            margin-top: var(--spacing-l);
            padding: var(--spacing-m);
            border-radius: var(--radiusMedium);
            display: none;
            font-size: var(--fontSizeBase);
            font-weight: var(--fontWeightRegular);
        }

        .status.success {
            background: #dff6dd;
            color: #107c10;
            border: 1px solid #92c47c;
            display: block;
        }

        .status.error {
            background: #fde7e9;
            color: #a80000;
            border: 1px solid #f4a5a9;
            display: block;
        }

        .status.info {
            background: #deecf9;
            color: #004578;
            border: 1px solid #b3d9f2;
            display: block;
        }

        .btn {
            padding: var(--spacing-s) var(--spacing-m);
            border: none;
            border-radius: var(--radiusMedium);
            font-size: var(--fontSizeBase);
            font-weight: var(--fontWeightSemibold);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: var(--colorBrandBackground);
            color: var(--colorBrandForeground);
        }

        .btn-primary:hover {
            background: rgb(40, 52, 68);
            box-shadow: var(--shadow2);
        }

        .btn-success {
            background: var(--colorAccent);
            color: var(--colorBrandBackground);
        }

        .btn-success:hover {
            background: var(--colorAccentHover);
            box-shadow: var(--shadow2);
        }

        .btn-secondary {
            background: var(--colorNeutralBackground3);
            color: var(--colorNeutralForeground1);
            border: 1px solid var(--colorNeutralStroke2);
        }

        .btn-secondary:hover {
            background: var(--colorNeutralStroke1);
            box-shadow: var(--shadow2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .btn {
                padding: var(--spacing-xs) var(--spacing-m);
                font-size: var(--fontSizeSmall);
                min-height: 28px;
            }
        }

        h2 {
            font-size: var(--fontSizeXLarge);
            font-weight: var(--fontWeightSemibold);
            color: var(--colorNeutralForeground1);
            margin-bottom: var(--spacing-m);
            line-height: 1.3;
        }

        h3 {
            font-size: var(--fontSizeLarge);
            font-weight: var(--fontWeightSemibold);
            color: var(--colorBrandBackground);
            margin-bottom: var(--spacing-m);
            margin-top: var(--spacing-xl);
            line-height: 1.3;
        }

        h3:first-child {
            margin-top: 0;
        }

        p {
            font-size: var(--fontSizeBase);
            color: var(--colorNeutralForeground2);
            margin-bottom: var(--spacing-m);
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            h2 {
                font-size: var(--fontSizeLarge);
            }
            
            h3 {
                font-size: var(--fontSizeMedium);
            }
        }

        /* Auth screens */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            z-index: 9999;
        }

        .auth-content {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.1);
            max-width: 400px;
        }

        .auth-content h2 {
            margin: 20px 0 10px;
            color: rgb(51, 65, 85);
        }

        .auth-content p {
            color: #666;
            margin: 10px 0;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e0e0e0;
            border-top-color: rgb(51, 65, 85);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Class tabs bar */
        .class-tabs {
            display: flex;
            gap: var(--spacing-xs);
            padding: var(--spacing-m);
            background: var(--colorNeutralBackground2);
            border-radius: var(--radiusMedium);
            overflow-x: auto;
            margin-bottom: var(--spacing-l);
            flex-wrap: wrap;
        }

        .class-tab {
            padding: var(--spacing-s) var(--spacing-m);
            background: var(--colorNeutralBackground1);
            border: 1px solid var(--colorNeutralStroke2);
            border-radius: var(--radiusMedium);
            font-size: var(--fontSizeSmall);
            font-weight: var(--fontWeightSemibold);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .class-tab:hover {
            background: var(--colorNeutralStroke1);
        }

        .class-tab.active {
            background: var(--colorBrandBackground);
            color: var(--colorBrandForeground);
            border-color: var(--colorBrandBackground);
        }

        /* Student list */
        .student-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--spacing-s);
            margin-bottom: var(--spacing-l);
        }

        .student-item {
            display: flex;
            align-items: center;
            padding: var(--spacing-m);
            background: var(--colorNeutralBackground1);
            border: 1px solid var(--colorNeutralStroke2);
            border-radius: var(--radiusMedium);
            cursor: pointer;
            transition: all 0.2s;
        }

        .student-item:hover {
            background: var(--colorNeutralBackground2);
            border-color: var(--colorBrandBackground);
        }

        .student-item.selected {
            background: rgba(255, 197, 38, 0.15);
            border-color: var(--colorAccent);
        }

        .student-item input[type="checkbox"] {
            margin-right: var(--spacing-s);
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .student-item label {
            cursor: pointer;
            flex: 1;
        }

        /* Selected students section */
        .selected-students-section {
            margin-bottom: var(--spacing-l);
        }

        .selected-student-card {
            background: var(--colorNeutralBackground2);
            border-radius: var(--radiusMedium);
            padding: var(--spacing-l);
            margin-bottom: var(--spacing-m);
            border-left: 4px solid var(--colorAccent);
            display: flex;
            gap: var(--spacing-l);
        }

        .selected-student-card .student-name-column {
            width: 25%;
            flex-shrink: 0;
            position: sticky;
            top: var(--spacing-l);
            align-self: flex-start;
        }

        .selected-student-card .conditions-column {
            width: 75%;
            flex-grow: 1;
        }

        .selected-student-card h4 {
            margin: 0;
            color: var(--colorBrandBackground);
            font-size: var(--fontSizeMedium);
            word-wrap: break-word;
        }

        @media (max-width: 768px) {
            .selected-student-card {
                flex-direction: column;
            }
            
            .selected-student-card .student-name-column {
                width: 100%;
                position: static;
                margin-bottom: var(--spacing-m);
            }
            
            .selected-student-card .conditions-column {
                width: 100%;
            }
        }

        /* Domain groups */
        .domain-group {
            margin-bottom: var(--spacing-m);
        }

        .domain-header {
            background: var(--colorBrandBackground);
            color: var(--colorBrandForeground);
            padding: var(--spacing-s) var(--spacing-m);
            border-radius: var(--radiusMedium) var(--radiusMedium) 0 0;
            font-weight: var(--fontWeightSemibold);
            font-size: var(--fontSizeSmall);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .domain-header:hover {
            background: rgb(40, 52, 68);
        }

        .domain-header .toggle-icon {
            transition: transform 0.2s;
        }

        .domain-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .domain-conditions {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: var(--spacing-xs);
            padding: var(--spacing-m);
            background: var(--colorNeutralBackground1);
            border: 1px solid var(--colorNeutralStroke2);
            border-top: none;
            border-radius: 0 0 var(--radiusMedium) var(--radiusMedium);
        }

        .domain-conditions.collapsed {
            display: none;
        }

        .condition-item {
            display: flex;
            align-items: flex-start;
            padding: var(--spacing-xs);
        }

        .condition-item input[type="checkbox"] {
            margin-right: var(--spacing-s);
            margin-top: 2px;
            width: 16px;
            height: 16px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .condition-item label {
            cursor: pointer;
            font-size: var(--fontSizeSmall);
            line-height: 1.4;
        }

        /* Stepper */
        .stepper {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-m);
        }

        .step {
            display: flex;
            align-items: center;
        }

        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--colorNeutralStroke2);
            color: var(--colorNeutralForeground2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--fontWeightSemibold);
            font-size: var(--fontSizeSmall);
        }

        .step.active .step-number {
            background: var(--colorBrandBackground);
            color: var(--colorBrandForeground);
        }

        .step.completed .step-number {
            background: var(--colorAccent);
            color: var(--colorBrandBackground);
        }

        .step-label {
            margin-left: var(--spacing-s);
            font-size: var(--fontSizeSmall);
            color: var(--colorNeutralForeground2);
        }

        .step.active .step-label {
            color: var(--colorNeutralForeground1);
            font-weight: var(--fontWeightSemibold);
        }

        .step-connector {
            width: 60px;
            height: 2px;
            background: var(--colorNeutralStroke2);
            margin: 0 var(--spacing-s);
        }

        .step-connector.completed {
            background: var(--colorAccent);
        }

        @media (max-width: 768px) {
            .step-label {
                display: none;
            }
            
            .step-connector {
                width: 30px;
            }
        }

        /* Action buttons container */
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-l);
            background: var(--colorNeutralBackground2);
            border-radius: var(--radiusMedium);
            margin-top: var(--spacing-l);
        }

        .action-bar .btn {
            min-width: 120px;
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: var(--spacing-xxl);
            color: var(--colorNeutralForeground2);
        }

        .spinner {
            border: 3px solid var(--colorNeutralStroke1);
            border-top: 3px solid var(--colorBrandBackground);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--spacing-l);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: var(--spacing-xxl);
            color: var(--colorNeutralForeground2);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: var(--spacing-m);
            stroke: var(--colorNeutralStroke2);
        }

        /* Modal (Professional) */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.55);
            z-index: 1000;
            overflow-y: auto;
            padding: var(--spacing-l) var(--spacing-m);
        }

        .modal-card {
            max-width: 1120px;
            margin: 0 auto;
            background: var(--colorNeutralBackground1);
            border-radius: 14px;
            box-shadow: var(--shadow16);
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.08);
        }

        .modal-header {
            padding: var(--spacing-m) var(--spacing-xl);
            border-bottom: 1px solid var(--colorNeutralStroke2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--spacing-l);
            background: linear-gradient(180deg, var(--colorNeutralBackground1), var(--colorNeutralBackground2));
        }

        .modal-title-wrap h2 {
            margin: 0;
        }

        .modal-title-wrap .modal-header-title {
            font-size: var(--fontSizeLarge);
            font-weight: var(--fontWeightSemibold);
            color: var(--colorNeutralForeground1);
            line-height: 1.2;
        }

        .modal-close-btn {
            border: 1px solid var(--colorNeutralStroke2);
            background: var(--colorNeutralBackground1);
            color: var(--colorNeutralForeground1);
            width: 36px;
            height: 36px;
            border-radius: 10px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .modal-close-btn:hover {
            background: var(--colorNeutralBackground2);
            box-shadow: var(--shadow2);
        }

        .modal-body {
            padding: var(--spacing-l) var(--spacing-xl);
        }

        .modal-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: var(--spacing-xl);
        }

        .panel {
            background: var(--colorNeutralBackground2);
            border: 1px solid var(--colorNeutralStroke2);
            border-radius: 12px;
            padding: var(--spacing-l);
        }

        .panel h3 {
            margin-top: 0;
            margin-bottom: var(--spacing-m);
        }

        .domains-panel {
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .student-context {
            padding: var(--spacing-l);
            border-bottom: 1px solid var(--colorNeutralStroke2);
            background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(250,249,248,1));
        }

        .student-context-top {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: var(--spacing-m);
        }

        .student-name {
            font-size: 22px;
            font-weight: var(--fontWeightSemibold);
            color: var(--colorBrandBackground);
            line-height: 1.15;
            margin: 0;
        }

        .student-meta {
            display: flex;
            align-items: center;
            gap: var(--spacing-s);
            margin-top: var(--spacing-s);
            flex-wrap: wrap;
        }

        .meta-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid var(--colorNeutralStroke2);
            background: var(--colorNeutralBackground1);
            color: var(--colorNeutralForeground1);
            font-size: var(--fontSizeSmall);
            font-weight: var(--fontWeightSemibold);
        }

        .meta-pill .label {
            color: var(--colorNeutralForeground2);
            font-weight: var(--fontWeightRegular);
        }

        .domains-section {
            padding: var(--spacing-l);
        }

        .domains-title {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: var(--spacing-m);
            margin-bottom: var(--spacing-m);
        }

        .domains-title h3 {
            margin: 0;
        }

        .domains-scroll {
            max-height: 520px;
            overflow: auto;
            padding-right: 6px;
        }

        .domains-empty {
            color: var(--colorNeutralForeground2);
            font-size: var(--fontSizeSmall);
        }

        .form-grid {
            display: grid;
            gap: var(--spacing-m);
        }

        .form-group {
            display: grid;
            gap: var(--spacing-xs);
        }

        .form-group label {
            font-weight: var(--fontWeightSemibold);
            color: var(--colorNeutralForeground1);
            font-size: var(--fontSizeSmall);
        }

        .help-text {
            color: var(--colorNeutralForeground2);
            font-size: var(--fontSizeSmall);
            line-height: 1.4;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--colorNeutralStroke2);
            border-radius: 10px;
            background: var(--colorNeutralBackground1);
            color: var(--colorNeutralForeground1);
            font-family: var(--fontFamilyBase);
            font-size: var(--fontSizeBase);
            line-height: 1.4;
            transition: box-shadow 0.15s ease, border-color 0.15s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: rgba(51, 65, 85, 0.7);
            box-shadow: 0 0 0 3px rgba(51, 65, 85, 0.12);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 96px;
        }

        textarea.form-control.short {
            min-height: 72px;
        }

        .form-control::placeholder {
            color: var(--colorNeutralForeground3);
        }

        .meeting-plan-note {
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-s);
            padding: var(--spacing-m);
            border-radius: 12px;
            background: rgba(255, 197, 38, 0.10);
            border: 1px solid rgba(255, 197, 38, 0.35);
            margin-bottom: var(--spacing-m);
        }

        .meeting-plan-note .icon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            margin-top: 2px;
            color: rgb(51, 65, 85);
        }

        /* Meeting modal: Goal-first UI */
        .meeting-plan-panel {
            position: relative;
            overflow: hidden;
        }

        .icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: 1px solid var(--colorNeutralStroke2);
            background: var(--colorNeutralBackground1);
            color: var(--colorNeutralForeground1);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .icon-btn:hover {
            background: var(--colorNeutralBackground2);
            box-shadow: var(--shadow2);
        }

        .icon-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }

        .goals-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--spacing-s);
            margin-top: var(--spacing-l);
            margin-bottom: var(--spacing-s);
        }

        .goals-table {
            display: grid;
            gap: 0;
            border: 1px solid var(--colorNeutralStroke2);
            border-radius: 12px;
            overflow: hidden;
            background: var(--colorNeutralBackground1);
        }

        .goals-row {
            display: grid;
            grid-template-columns: 1fr 92px;
            gap: var(--spacing-s);
            align-items: center;
            padding: 10px 10px;
            border-top: 1px solid var(--colorNeutralStroke2);
        }

        .goals-row:first-child {
            border-top: none;
        }

        .goals-row-header {
            background: var(--colorNeutralBackground2);
            font-size: var(--fontSizeSmall);
            font-weight: var(--fontWeightSemibold);
            color: var(--colorNeutralForeground2);
        }

        .goals-row-empty {
            background: var(--colorNeutralBackground1);
        }

        .slide-panel {
            position: absolute;
            inset: 0;
            background: var(--colorNeutralBackground2);
            border-left: 1px solid var(--colorNeutralStroke2);
            padding: var(--spacing-l);
            transform: translateX(104%);
            transition: transform 0.22s ease;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-m);
            overflow: hidden;
        }

        .slide-panel.open {
            transform: translateX(0);
        }

        .slide-panel-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-s);
        }

        .actionplans-table {
            display: grid;
            border: 1px solid var(--colorNeutralStroke2);
            border-radius: 12px;
            /* Make the action plans LIST scroll (not the whole slide panel) */
            min-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
            background: var(--colorNeutralBackground1);
        }

        .ap-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: var(--spacing-s);
            align-items: center;
            /* This drives the "cell padding" you're seeing */
            padding: 6px 8px;
            border-top: 1px solid var(--colorNeutralStroke2);
        }

        .ap-detail {
            grid-column: 1 / 4; /* span 3 columns */
        }

        .ap-detail textarea.form-control {
            min-height: 88px;
        }

        .ap-row:first-child {
            border-top: none;
        }

        .ap-row-header {
            background: var(--colorNeutralBackground2);
            font-size: var(--fontSizeSmall);
            font-weight: var(--fontWeightSemibold);
            color: var(--colorNeutralForeground2);
            padding: 8px 10px;
        }

        .ap-row-empty {
            background: var(--colorNeutralBackground1);
        }

        /* Read-only fields (quick reference) */
        .readonly-field {
            background: var(--colorNeutralBackground1);
            border: 1px solid var(--colorNeutralStroke2);
            border-radius: 12px;
            padding: 12px 12px;
            color: var(--colorNeutralForeground1);
            font-size: var(--fontSizeBase);
            line-height: 1.45;
            white-space: pre-wrap;
            min-height: 44px;
        }

        .readonly-field.muted {
            color: var(--colorNeutralForeground2);
        }

        /* Large switch */
        .switch-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--spacing-m);
            padding: var(--spacing-m);
            border-radius: 12px;
            background: var(--colorNeutralBackground1);
            border: 1px solid var(--colorNeutralStroke2);
        }

        .switch-row .switch-label {
            display: grid;
            gap: 2px;
        }

        .switch-row .switch-label strong {
            font-weight: var(--fontWeightSemibold);
            color: var(--colorNeutralForeground1);
        }

        .switch-row .switch-label span {
            font-size: var(--fontSizeSmall);
            color: var(--colorNeutralForeground2);
        }

        /* Fluent-like switch */
        .toggle {
            position: relative;
            width: 52px;
            height: 28px;
            flex-shrink: 0;
            display: inline-block;
        }

        /* Make the input capture clicks */
        .toggle input {
            position: absolute;
            inset: 0;
            opacity: 0;
            margin: 0;
            cursor: pointer;
        }

        .toggle .track {
            position: absolute;
            inset: 0;
            background: #c8c6c4; /* Fluent neutral */
            border-radius: 999px;
            box-shadow: inset 0 0 0 1px rgba(0,0,0,0.10);
            transition: background 120ms ease, box-shadow 120ms ease;
        }

        .toggle .thumb {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: #ffffff;
            border-radius: 999px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.18), 0 2px 8px rgba(0,0,0,0.12);
            transition: transform 120ms ease;
        }

        /* On state = green */
        .toggle input:checked + .track {
            background: var(--colorSuccess);
            box-shadow: inset 0 0 0 1px rgba(0,0,0,0.10);
        }

        .toggle input:checked + .track .thumb {
            transform: translateX(24px);
        }

        /* Hover */
        .toggle input:hover + .track {
            box-shadow: inset 0 0 0 1px rgba(0,0,0,0.16);
        }

        /* Focus ring */
        .toggle input:focus-visible + .track {
            box-shadow:
                inset 0 0 0 1px rgba(0,0,0,0.12),
                0 0 0 3px rgba(51, 65, 85, 0.18);
        }

        /* Disabled */
        .toggle input:disabled {
            cursor: not-allowed;
        }

        .toggle input:disabled + .track {
            opacity: 0.55;
        }

        @media (prefers-reduced-motion: reduce) {
            .toggle .track,
            .toggle .thumb {
                transition: none;
            }
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-s);
            margin-top: var(--spacing-m);
        }

        @media (max-width: 920px) {
            .modal-body {
                padding: var(--spacing-l);
            }
            .modal-header {
                padding: var(--spacing-l);
            }
            .modal-grid {
                grid-template-columns: 1fr;
            }
            .domains-scroll {
                max-height: 360px;
            }
        }

        /* Table styles for Review Outcomes */
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--colorNeutralBackground1);
            box-shadow: var(--shadow2);
            margin-top: var(--spacing-l);
            border-radius: var(--radiusMedium);
            overflow: hidden;
        }

        .clickable-row {
            cursor: pointer;
        }

        .clickable-row:hover td {
            background: var(--colorNeutralBackground2);
        }

        .section-header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: var(--spacing-m);
            margin-top: var(--spacing-xl);
        }

        .section-header h3 {
            margin: 0;
        }

        .count-pill {
            font-size: var(--fontSizeSmall);
            color: var(--colorNeutralForeground2);
            border: 1px solid var(--colorNeutralStroke2);
            background: var(--colorNeutralBackground1);
            border-radius: 999px;
            padding: 4px 10px;
        }

        th {
            background: var(--colorBrandBackground);
            color: var(--colorBrandForeground);
            padding: var(--spacing-m) var(--spacing-l);
            text-align: left;
            font-weight: var(--fontWeightSemibold);
            font-size: var(--fontSizeSmall);
            position: sticky;
            top: 0;
            z-index: 10;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: var(--spacing-m) var(--spacing-l);
            border-bottom: 1px solid var(--colorNeutralStroke1);
            font-size: var(--fontSizeBase);
            vertical-align: top;
        }

        tr:hover {
            background: var(--colorNeutralBackground2);
        }

        @media (max-width: 768px) {
            table {
                font-size: var(--fontSizeSmall);
                display: block;
                overflow-x: auto;
            }
            
            th, td {
                padding: var(--spacing-s) var(--spacing-m);
                white-space: nowrap;
            }
        }

        /* Review Outcomes - Student Cards */
        .outcomes-student-card {
            display: flex;
            align-items: center;
            padding: var(--spacing-m);
            background: var(--colorNeutralBackground1);
            border: 1px solid var(--colorNeutralStroke2);
            border-radius: var(--radiusMedium);
            cursor: pointer;
            transition: all 0.2s;
            gap: var(--spacing-m);
        }

        .outcomes-student-card:hover {
            background: var(--colorNeutralBackground2);
            border-color: var(--colorBrandBackground);
        }

        .outcomes-student-info {
            flex: 1;
            min-width: 0;
        }

        .outcomes-student-name {
            font-weight: var(--fontWeightSemibold);
            color: var(--colorNeutralForeground1);
        }

        .outcomes-student-meta {
            margin-top: var(--spacing-xs);
            color: var(--colorNeutralForeground2);
            font-size: var(--fontSizeSmall);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .outcomes-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: var(--fontSizeSmall);
            font-weight: var(--fontWeightSemibold);
        }

        .outcomes-badge.warning {
            background: rgba(255, 152, 0, 0.15);
            color: #e65100;
        }

        .outcomes-badge.success {
            background: rgba(16, 124, 16, 0.15);
            color: #107c10;
        }

        /* Action Plan Item in Modal */
        .action-plan-review-item {
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-m);
            padding: var(--spacing-m);
            background: var(--colorNeutralBackground2);
            border-radius: var(--radiusMedium);
            margin-bottom: var(--spacing-s);
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .action-plan-review-item:hover {
            background: var(--colorNeutralBackground3);
            border-color: var(--colorBrandBackground);
        }

        .action-plan-review-item.completed {
            opacity: 0.7;
        }

        .action-plan-icon {
            flex-shrink: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-plan-icon.warning svg {
            color: #e65100;
        }

        .action-plan-icon.success svg {
            color: #107c10;
        }

        .action-plan-content {
            flex: 1;
            min-width: 0;
        }

        .action-plan-goal {
            font-weight: var(--fontWeightSemibold);
            color: var(--colorNeutralForeground1);
            margin-bottom: var(--spacing-xs);
        }

        .action-plan-details {
            font-size: var(--fontSizeSmall);
            color: var(--colorNeutralForeground2);
        }

        .action-plan-meta {
            display: flex;
            gap: var(--spacing-m);
            margin-top: var(--spacing-xs);
            font-size: var(--fontSizeSmall);
            color: var(--colorNeutralForeground3);
        }

        .action-plan-chevron {
            flex-shrink: 0;
            color: var(--colorNeutralForeground3);
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="auth-screen" style="display: flex;">
        <div class="auth-content">
            <div class="loading-spinner"></div>
            <h2>Loading...</h2>
            <p>Checking authentication</p>
        </div>
    </div>

    <!-- Teams Required Screen -->
    <div id="teamsRequiredScreen" class="auth-screen" style="display: none;">
        <div class="auth-content">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="rgb(51, 65, 85)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <h2>Microsoft Teams Required</h2>
            <p>This app can only be accessed within Microsoft Teams.</p>
            <p style="font-size: 14px; color: #666;">Please open this app from the Teams desktop or web client.</p>
        </div>
    </div>

    <!-- Access Denied Screen -->
    <div id="accessDeniedScreen" class="auth-screen" style="display: none;">
        <div class="auth-content">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ac0027" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
            </svg>
            <h2>Access Denied</h2>
            <p>You must be signed in with an <strong>@acsacademy.edu.sg</strong> account.</p>
            <p style="font-size: 14px; color: #666;">Current account: <span id="deniedEmail">Unknown</span></p>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="app-container" style="display: none;">
        <!-- <div class="header" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>AP Student Support</h1>
            </div>
            <div id="userInfo" style="text-align: right; font-size: var(--fontSizeSmall); opacity: 0.9;"></div>
        </div> -->

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showView('home')">Home</button>
            <button class="nav-tab" onclick="showView('refer')" id="referTab">Refer Student</button>
            <button class="nav-tab" onclick="showView('meeting')" id="meetingTab">Support Meeting</button>
            <button class="nav-tab" onclick="showView('outcomes')" id="outcomesTab">Review Outcomes</button>
        </div>

        <!-- Home View -->
        <div id="homeView" class="view-container active">
            <div class="main-menu" id="mainMenu">
                <div class="menu-card menu-card-yellow" onclick="showView('refer')">
                    <div class="menu-card-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M22 12h-6"></path>
                            <path d="M19 9l3 3-3 3"></path>
                        </svg>
                    </div>
                    <h2>Refer Student</h2>
                    <p>Submit a new student support referral</p>
                </div>
                <div class="menu-card menu-card-blue" onclick="showView('meeting')">
                    <div class="menu-card-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                    </div>
                    <h2>Student Support Meeting</h2>
                    <p>Record and manage support meetings</p>
                </div>
                <div class="menu-card menu-card-red" onclick="showView('outcomes')">
                    <div class="menu-card-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 11l3 3L22 4"></path>
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                        </svg>
                    </div>
                    <h2>Review Outcomes</h2>
                    <p>View and track student support outcomes</p>
                </div>
            </div>
        </div>

        <!-- Refer Student View -->
        <div id="referView" class="view-container">
            <!-- Stepper -->
            <div class="stepper">
                <div class="step active" id="step1">
                    <div class="step-number">1</div>
                    <span class="step-label">Select Students</span>
                </div>
                <div class="step-connector" id="connector1"></div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    <span class="step-label">Select Conditions</span>
                </div>
                <div class="step-connector" id="connector2"></div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    <span class="step-label">Submit</span>
                </div>
            </div>

            <!-- Step 1: Select Students -->
            <div id="referStep1">
                <h2>Step 1: Select Students to Refer</h2>
                <p>First, select a class, then choose the students you want to refer.</p>
                
                <!-- Class tabs -->
                <div class="class-tabs" id="classTabsContainer">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading classes...
                    </div>
                </div>

                <!-- Student list -->
                <div id="studentListContainer">
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                        </svg>
                        <p>Select a class to view students</p>
                    </div>
                </div>

                <div class="action-bar">
                    <button class="btn btn-secondary" onclick="showView('home')">Cancel</button>
                    <button class="btn btn-primary" onclick="goToStep2()" id="nextToStep2Btn" disabled>
                        Next: Select Conditions
                    </button>
                </div>
            </div>

            <!-- Step 2: Select Conditions -->
            <div id="referStep2" style="display: none;">
                <h2>Step 2: Select Conditions</h2>
                <p>For each student, select the relevant conditions grouped by domain.</p>

                <div class="form-group" style="max-width: 520px; margin-bottom: var(--spacing-l);">
                    <label for="conditionsSearch">Search conditions</label>
                    <input
                        id="conditionsSearch"
                        class="form-control"
                        type="text"
                        placeholder="Type to filter (e.g., 'memory', 'anxious', 'homework')"
                        oninput="setConditionsSearch(this.value)"
                    />
                    <div class="help-text">While searching, all domains expand and only matching conditions are shown.</div>
                </div>

                <div id="selectedStudentsContainer">
                    <!-- Selected students with condition checkboxes will be rendered here -->
                </div>

                <div class="action-bar">
                    <button class="btn btn-secondary" onclick="goToStep1()">Back</button>
                    <button class="btn btn-primary" onclick="goToStep3()" id="nextToStep3Btn" disabled>
                        Next: Review & Submit
                    </button>
                </div>
            </div>

            <!-- Step 3: Review & Submit -->
            <div id="referStep3" style="display: none;">
                <h2>Step 3: Review & Submit</h2>
                <p>Review the referrals below and click Submit when ready.</p>

                <div id="reviewContainer">
                    <!-- Review summary will be rendered here -->
                </div>

                <div class="action-bar">
                    <button class="btn btn-secondary" onclick="goToStep2FromReview()">Back</button>
                    <button class="btn btn-success" onclick="submitReferrals()" id="submitBtn">
                        Submit Referrals
                    </button>
                </div>
            </div>
        </div>

        <!-- Support Meeting View -->
        <div id="meetingView" class="view-container">
            <h2>Student Support Meeting</h2>
            <p>Select a class to view referred students and complete the support meeting plan.</p>

            <div class="class-tabs" id="meetingClassTabsContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading classes...
                </div>
            </div>

            <div id="meetingStudentsContainer">
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                    </svg>
                    <p>Select a class to view students</p>
                </div>
            </div>
        </div>

        <!-- Meeting Modal -->
        <div id="meetingModal" class="modal-overlay" style="display: none;">
            <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="meetingStudentName">
                <div class="modal-body">
                    <div class="modal-grid">
                        <div class="panel domains-panel">
                            <div class="student-context">
                                <div class="student-context-top">
                                    <div style="min-width: 0;">
                                        <h2 id="meetingStudentName" class="student-name">Student</h2>
                                        <div class="student-meta">
                                            <span class="meta-pill">
                                                <span class="label">Ref ID</span>
                                                <span id="meetingStudentRefId"></span>
                                            </span>
                                        </div>
                                    </div>
                                    <button class="modal-close-btn" onclick="closeMeetingModal()" aria-label="Close">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="domains-section">
                                <div class="domains-title">
                                    <h3>Strengths</h3>
                                </div>
                                <div id="meetingModalStrengths" class="domains-empty"></div>

                                <div class="domains-title" style="margin-top: var(--spacing-l);">
                                    <h3>Subjects</h3>
                                </div>
                                <div id="meetingModalSubjects" class="domains-empty"></div>

                                <div class="domains-title" style="margin-top: var(--spacing-l);">
                                    <h3>Conditions &amp; Issues</h3>
                                </div>
                                <div class="domains-scroll">
                                    <div id="meetingModalDomains" class="domains-empty">Loading</div>
                                </div>
                            </div>
                        </div>

                        <div class="panel meeting-plan-panel">
                            <div class="meeting-plan-header">
                                <h3 style="margin: 0;">Meeting Notes</h3>
                            </div>

                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="meetingNotes">Meeting Notes</label>
                                    <textarea class="form-control" id="meetingNotes" rows="5" placeholder="Notes from the meeting..."></textarea>
                                </div>
                            </div>

                            <div class="goals-header">
                                <h3 style="margin: 0;">Goals</h3>
                                <button class="icon-btn" type="button" onclick="addMeetingGoalRow()" aria-label="Add goal" title="Add goal">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg>
                                </button>
                            </div>

                            <div class="goals-table">
                                <div class="goals-row goals-row-header">
                                    <div>Goal</div>
                                    <div style="text-align:right;">Action Plans</div>
                                </div>
                                <div id="meetingGoalsTableBody">
                                    <!-- goal rows rendered by JS -->
                                </div>
                            </div>

                            <!-- Slide-in Action Plans panel (per Goal) -->
                            <div id="meetingGoalActionPanel" class="slide-panel" aria-hidden="true">
                                <div class="slide-panel-header">
                                    <button class="icon-btn" type="button" onclick="closeGoalActionPanel()" aria-label="Back to goals" title="Back">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="15 18 9 12 15 6"></polyline>
                                        </svg>
                                    </button>
                                    <div style="min-width:0;">
                                        <div style="font-weight: var(--fontWeightSemibold);">Goal</div>
                                        <div id="meetingActiveGoalTitle" style="color: var(--colorNeutralForeground2); font-size: var(--fontSizeSmall); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></div>
                                    </div>
                                    <div style="flex:1;"></div>
                                    <button class="icon-btn" type="button" onclick="addMeetingActionPlanRow()" aria-label="Add action plan" title="Add action plan">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                    </button>
                                </div>

                                <div class="actionplans-table">
                                    <div class="ap-row ap-row-header">
                                        <div style="grid-column: 1 / -1;">Action Plans</div>
                                    </div>
                                    <div id="meetingActionPlansTableBody">
                                        <!-- action plan rows rendered by JS -->
                                    </div>
                                </div>
                            </div>

                            <div class="modal-actions">
                                <button class="btn btn-secondary" onclick="closeMeetingModal()">Cancel</button>
                                <button class="btn btn-primary" id="meetingSubmitBtn" onclick="submitMeetingPlan()">Save Notes</button>
                            </div>

                            <div id="meetingModalStatus" class="status" style="margin-top: var(--spacing-m);"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Review Outcomes View -->
        <div id="outcomesView" class="view-container">
            <h2>Review Outcomes</h2>
            <p>Review action plans that are due for review. Mark goals as completed when outcomes are achieved.</p>

            <div class="section-header">
                <h3>Pending Review</h3>
                <span class="count-pill" id="pendingCount">0</span>
            </div>
            <div id="pendingOutcomesContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading pending reviews...
                </div>
            </div>

            <div class="section-header">
                <h3>Completed</h3>
                <span class="count-pill" id="completedCount">0</span>
            </div>
            <div id="completedOutcomesContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading completed reviews...
                </div>
            </div>
        </div>
        <!-- Outcomes Student Modal - Shows list of action plans for a student -->
        <div id="outcomesStudentModal" class="modal-overlay" style="display: none;">
            <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="outcomesStudentModalName" style="max-width: 700px;">
                <div class="modal-body" style="padding: var(--spacing-l);">
                    <div class="student-context">
                        <div class="student-context-top">
                            <div style="min-width: 0;">
                                <h2 id="outcomesStudentModalName" class="student-name">Student</h2>
                                <div class="student-meta">
                                    <span class="meta-pill">
                                        <span class="label">Ref ID</span>
                                        <span id="outcomesStudentModalRefId"></span>
                                    </span>
                                </div>
                            </div>
                            <button class="modal-close-btn" onclick="closeOutcomesStudentModal()" aria-label="Close">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="modal-grid" style="grid-template-columns: 1fr 1fr; gap: var(--spacing-l); margin-top: var(--spacing-l);">
                        <div class="panel domains-panel">
                            <div class="domains-section" style="padding: 15px;">
                                <div class="domains-title">
                                    <h3>Strengths</h3>
                                </div>
                                <div id="outcomesStudentModalStrengths" class="domains-empty"></div>

                                <div class="domains-title" style="margin-top: var(--spacing-l);">
                                    <h3>Domains &amp; Conditions</h3>
                                </div>
                                <div class="domains-scroll" style="max-height: 260px;">
                                    <div id="outcomesStudentModalDomains" class="domains-empty"></div>
                                </div>

                                <div class="domains-title" style="margin-top: var(--spacing-l);">
                                    <h3>Meeting Notes</h3>
                                </div>
                                <div id="outcomesStudentModalMeetingNotes" class="domains-empty"></div>
                            </div>
                        </div>

                        <div>
                            <h3 style="margin-bottom: var(--spacing-m);">Action Plans</h3>
                            <div id="outcomesStudentModalActionPlans">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    Loading action plans...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Goal Review Modal - For marking a goal as complete -->
        <div id="goalReviewModal" class="modal-overlay" style="display: none;">
            <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="goalReviewModalTitle" style="max-width: 550px;">
                <div class="modal-body" style="padding: var(--spacing-l);">
                    <div class="student-context">
                        <div class="student-context-top">
                            <div style="min-width: 0;">
                                <h2 id="goalReviewModalTitle" style="font-size: var(--fontSizeLarge);">Review Goal</h2>
                            </div>
                            <button class="modal-close-btn" onclick="closeGoalReviewModal()" aria-label="Close">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div style="margin-top: var(--spacing-l);">
                        <div style="background: var(--colorNeutralBackground2); padding: var(--spacing-m); border-radius: var(--radiusMedium); margin-bottom: var(--spacing-l);">
                            <div style="font-size: var(--fontSizeSmall); color: var(--colorNeutralForeground2); margin-bottom: var(--spacing-xs);">Goal</div>
                            <div id="goalReviewModalGoalText" style="font-weight: var(--fontWeightSemibold);"></div>
                        </div>
                        
                        <div style="background: var(--colorNeutralBackground2); padding: var(--spacing-m); border-radius: var(--radiusMedium); margin-bottom: var(--spacing-l);">
                            <div style="font-size: var(--fontSizeSmall); color: var(--colorNeutralForeground2); margin-bottom: var(--spacing-xs);">Action Plan</div>
                            <div id="goalReviewModalActionPlanText"></div>
                            <div style="display: flex; gap: var(--spacing-m); margin-top: var(--spacing-s);">
                                <div>
                                    <span style="font-size: var(--fontSizeSmall); color: var(--colorNeutralForeground3);">Action by: </span>
                                    <span id="goalReviewModalActionBy" style="font-size: var(--fontSizeSmall);"></span>
                                </div>
                                <div>
                                    <span style="font-size: var(--fontSizeSmall); color: var(--colorNeutralForeground3);">Review date: </span>
                                    <span id="goalReviewModalReviewDate" style="font-size: var(--fontSizeSmall);"></span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group" style="margin-bottom: var(--spacing-l);">
                            <div class="switch-row" style="display: flex; align-items: center; gap: var(--spacing-m);">
                                <div class="switch-label" style="flex: 1;">
                                    <strong>Goal Completed</strong>
                                    <div style="font-size: var(--fontSizeSmall); color: var(--colorNeutralForeground2);">Mark this goal as achieved</div>
                                </div>
                                <div class="fluent-switch">
                                    <input 
                                        type="checkbox" 
                                        id="goalReviewCompletedSwitch" 
                                        class="fluent-switch-input" 
                                        aria-label="Goal Completed"
                                    />
                                    <label for="goalReviewCompletedSwitch" class="fluent-switch-label">
                                        <span class="fluent-switch-slider" aria-hidden="true"></span>
                                    </label>
                                </div>
                                <style>
                                    .fluent-switch {
                                        position: relative;
                                        display: inline-block;
                                        width: 52px;
                                        height: 28px;
                                    }
                                    .fluent-switch-input {
                                        opacity: 0;
                                        width: 0;
                                        height: 0;
                                    }
                                    .fluent-switch-label {
                                        position: absolute;
                                        cursor: pointer;
                                        top: 0; left: 0; right: 0; bottom: 0;
                                        background: var(--colorNeutralBackground3, #eee);
                                        border-radius: 16px;
                                        transition: background 0.3s;
                                        border: 1.5px solid var(--colorNeutralStroke2, #c2c6cc);
                                    }
                                    .fluent-switch-slider {
                                        position: absolute;
                                        left: 3px;
                                        top: 3px;
                                        width: 22px;
                                        height: 22px;
                                        border-radius: 50%;
                                        background: var(--colorNeutralForeground1, #274472);
                                        transition: transform 0.25s cubic-bezier(.77,0,.18,1), background 0.25s;
                                        box-shadow: 0 1px 3px rgba(30,34,43,0.07);
                                    }
                                    .fluent-switch-input:checked + .fluent-switch-label {
                                        background: var(--colorBrandBackground, #005cb9);
                                        border-color: var(--colorBrandBackground, #005cb9);
                                    }
                                    .fluent-switch-input:checked + .fluent-switch-label .fluent-switch-slider {
                                        background: var(--colorBrandForegroundInverted, #fff);
                                        transform: translateX(24px);
                                    }
                                    .fluent-switch-input:focus + .fluent-switch-label {
                                        box-shadow: 0 0 0 2px var(--colorBrandBackground, #005cb9)55;
                                        outline: 0;
                                    }
                                </style>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="goalReviewNotes">Completion Notes</label>
                            <textarea id="goalReviewNotes" class="form-control" rows="4" placeholder="Enter notes about the goal outcome..."></textarea>
                        </div>
                    </div>

                    <div class="modal-actions" style="margin-top: var(--spacing-l);">
                        <button class="btn btn-secondary" onclick="closeGoalReviewModal()">Close</button>
                        <button class="btn btn-primary" id="goalReviewSaveBtn" onclick="saveGoalReview()">Save</button>
                    </div>
                    <div id="goalReviewModalStatus" class="status" style="margin-top: var(--spacing-m);"></div>
                </div>
            </div>
        </div>

        <div id="status" class="status"></div>
    </div>

    <script>
        // ============================================================================
        // CONFIGURATION
        // ============================================================================
        const ALLOWED_DOMAIN = '@acsacademy.edu.sg';

        // Use existing attendance API for class + student lists
        const LISTS_API_BASE_URL = 'https://parents.acsacademy.edu.sg/api/attendanceGateway.php';

        // Referral creation (Dataverse write) API
        // Production target: parents.acsacademy.edu.sg/api/apReferral.php
        const REFERRAL_API_BASE_URL = 'https://parents.acsacademy.edu.sg/api/apReferral.php';
        // Basic API key (NOTE: this is visible in the browser; use as a basic gate, not true secrecy)
        // Must match the server env var `AP_REFERRAL_API_KEY` (or `AP_API_KEY`).
        // This value should be injected from the GitHub Actions variable "AP_REFERRAL_API_KEY"
        // For deployment: replace this placeholder via your build pipeline (e.g., using envsubst or a build script)
        const AP_REFERRAL_API_KEY = typeof AP_REFERRAL_API_KEY !== 'undefined'
            ? AP_REFERRAL_API_KEY
            : (window.AP_REFERRAL_API_KEY || '__AP_REFERRAL_API_KEY_PLACEHOLDER__');

        // Azure AD Configuration (for reference - actual auth is handled server-side)
        const AZURE_CONFIG = {
            clientId: '7d1340e2-9fa9-4a80-8b89-93e5bced6ebc',
            tenantId: '6dff32de-1cd0-4ada-892b-2298e1f61698'
        };

        // ============================================================================
        // DOMAINS AND CONDITIONS DATA
        // ============================================================================
        const DOMAINS_AND_CONDITIONS = {
            "Cognitive": [
                "Has poor comprehension of material",
                "Has poor short-term memory for verbal stimuli",
                "Has poor short-term memory for nonverbal stimuli",
                "Has limited attention span",
                "Has difficulty understanding oral directions",
                "Has difficulty understanding written directions",
                "Has difficulty following a sequence of directions",
                "Misunderstands material presented at a fast rate",
                "Has difficulty recalling story sequences",
                "Has difficulty understanding teacher when he or she moves around the room",
                "Has difficulty being adaptable",
                "Has difficulty reasoning abstractly",
                "Has difficulty conceptualizing material",
                "Uses problem-solving strategies inefficiently",
                "Learns very slowly",
                "Has poor long-term memory",
                "Forgets newly learned skills"
            ],
            "Language/Academic": [
                "Has difficulty decoding words",
                "Has poor reading comprehension",
                "Has poor expressive language",
                "Has poor listening comprehension",
                "Uses gestures instead of words",
                "Has difficulty rapidly naming objects",
                "Has difficulty rapidly reading words",
                "Has speech impairment",
                "Has difficulty producing rhymes",
                "Has difficulty recognizing similar phonemes",
                "Has difficulty arranging phonemes into words",
                "Has difficulty using verbal coding as an aid in memory",
                "Has difficulty using verbal coding as an aid in rehearsal",
                "Has poor grammar",
                "Has poor math computation skills",
                "Has limited math problem-solving skills",
                "Does not retain math facts",
                "Has poor spelling",
                "Has fluctuating performance",
                "Has difficulty writing compositions",
                "Does not know names of common objects"
            ],
            "Perceptual/Motor": [
                "Has poor auditory perception",
                "Has poor visual perception",
                "Has poor tactile discrimination",
                "Has poor handwriting",
                "Has clumsy and awkward movements",
                "Has poor speech communication",
                "Has difficulty putting objects in correct sequence",
                "Has difficulty remembering sequence of objects",
                "Has right-left confusion",
                "Has poor gross-motor coordination",
                "Has poor fine-motor coordination",
                "Moves slowly",
                "Has slumped posture",
                "Has rigid, tense posture",
                "Has atypical, inappropriate posture"
            ],
            "Behavioral": [
                "Avoids doing work in class",
                "Gives up easily",
                "Has difficulty beginning tasks on time",
                "Has difficulty completing tasks on time",
                "Asks questions constantly",
                "Is impulsive",
                "Has trouble starting and continuing tasks",
                "Has difficulty changing from one assignment to another",
                "Shifts often to other activities",
                "Has difficulty working independently",
                "Has difficulty playing quietly",
                "Is easily distracted",
                "Doesn't seem to listen",
                "Shows aggressive behavior",
                "Shows disruptive behavior",
                "Talks excessively",
                "Interrupts others often",
                "Speaks out of turn (often blurts out answers)",
                "Makes comments not related to topic being discussed",
                "Has difficulty remaining seated",
                "Fidgets often when seated",
                "Fails to return on time to class",
                "Has limited persistence",
                "Fails to do homework",
                "Loses homework",
                "Seeks attention constantly",
                "Is unorganized",
                "Uses immature vocabulary",
                "Is slow to complete tasks",
                "Behaves inappropriately",
                "Uses drugs or alcohol",
                "Hurts others",
                "Is cruel to animals",
                "Talks about suicide",
                "Destroys others' property",
                "Is out of chair when supposed to be doing work",
                "Has constant and repetitive behavior",
                "Speaks slowly",
                "Shouts or yells for no apparent reason",
                "Has hallucinations",
                "Stutters",
                "Injures self often",
                "Bites nails",
                "Bangs head",
                "Holds breath",
                "Does not tolerate changes in routine",
                "Wanders aimlessly around room",
                "Daydreams",
                "Is often sleepy or lethargic",
                "Tires easily",
                "Tells lies",
                "Steals",
                "Has numerous physical complaints",
                "Is often tardy",
                "Is frequently absent",
                "Has poor eye contact",
                "Requires constant supervision",
                "Engages in dangerous behaviors",
                "Has been suspended in the past",
                "Prefers not to try new activities",
                "Fails to use free time appropriately"
            ],
            "Social": [
                "Is immature",
                "Is stubborn",
                "Has low self-esteem",
                "Is socially isolated",
                "Is not popular",
                "Has difficulty communicating interests",
                "Has difficulty accepting criticism",
                "Has limited social perceptiveness",
                "Gives in to peer pressure",
                "Is uncooperative",
                "Has poor skills on playground",
                "Is overly compliant",
                "Is selfish",
                "Seems suspicious of other people",
                "Refuses to share",
                "Shows sexually provocative behavior",
                "Blames others for problems",
                "Has difficulty seeking help",
                "Has difficulty accepting help from teacher",
                "Has difficulty accepting help from peers",
                "Does not get along with other children",
                "Does not offer opinions and answers when asked",
                "Does not enjoy group activities",
                "Does not show concern for others' feelings and property",
                "Resolves conflicts by shouting, fighting, or intimidating others",
                "Has difficulty making constructive contributions during group activities",
                "Avoids others completely",
                "Has anger management problems",
                "Displays inappropriate humor",
                "Seeks to manipulate others",
                "Is rigid and opinionated",
                "Has unusual interest in sensational violence",
                "Is fascinated with violence-filled entertainment",
                "Bullies other children",
                "Is the victim of bullying"
            ],
            "Affect/Motivation": [
                "Is easily frustrated",
                "Shows anger quickly",
                "Has limited motivation",
                "Is often anxious",
                "Is depressed or unhappy",
                "Has low interest in schoolwork",
                "Is self-critical",
                "Is overexcitable",
                "Is hyperactive",
                "Has temper tantrums",
                "Has unusual fears",
                "Is easily annoyed",
                "Frequently cries",
                "Is tense and fearful",
                "Seldom shows emotion",
                "Is shy or timid",
                "Is upset by changes in routine",
                "Has wide mood swings",
                "Appears to feel hopeless",
                "Has difficulty recognizing that he or she has a problem"
            ],
            "Self Care Skills": [
                "Has poor personal hygiene",
                "Has disheveled and unclean personal appearance",
                "Fails to dress appropriately for weather",
                "Has poor table manners in cafeteria",
                "Engages in self-stimulating behaviors"
            ],
            "Physical Health": [
                "Has vision problems",
                "Has hearing problems",
                "Has dental problems",
                "Complains of headaches",
                "Complains of stomach pains",
                "Complains of fatigue",
                "Is overweight",
                "Is underweight",
                "Complains of loss of appetite",
                "Has a physical disability (describe: )",
                "Has a chronic illness (describe: )",
                "Has other physical health problems (describe: )"
            ]
        };

        // ============================================================================
        // STATE VARIABLES
        // ============================================================================
        let isInTeams = false;
        let isAuthenticated = false;
        let authChecked = false;
        let currentUserEmail = null;
        let currentUserDisplayName = null;
        let currentUserId = null;

        let classes = [];
        let students = [];
        let selectedClass = null;
        let selectedStudents = {};  // studentId -> student object
        let studentConditions = {}; // studentId -> { domain -> [conditions] }
        let conditionsSearch = '';
        let studentStrengths = {}; // studentId -> string
        let studentPreferredSubjects = {}; // studentId -> string[]
        let studentTriggerSubjects = {}; // studentId -> string[]

        const SUBJECT_OPTIONS = [
            'English',
            'Math',
            'Life Skill',
            'CCE',
            'Music',
            'Aesthetics',
            'PE',
            'Science',
            'Others'
        ];

        // Meeting state
        let meetingClasses = [];
        let meetingSelectedClass = null;
        let meetingStudents = []; // students in class
        let meetingStudentLatestCase = {}; // studentId -> case object (latest)
        let meetingActiveStudent = null; // { student, case }
        let meetingGoalsState = []; // [{ id, text }]
        let meetingActionPlansState = {}; // goalId -> [{ id, actionPlanDetails, actionBy, reviewDate, status }]
        let meetingActiveGoalId = null;

        // ============================================================================
        // AUTHENTICATION
        // ============================================================================
        async function checkAuthentication() {
            try {
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

                // 1. Priority: Local Development Bypass
                if (isLocalhost) {
                    console.info(' Localhost detected: Bypassing Teams Auth');
                    isInTeams = false;
                    isAuthenticated = true; 
                    currentUserEmail = 'dev@' + ALLOWED_DOMAIN;
                    currentUserDisplayName = 'Local Dev User';
                    currentUserId = 'dev-123';
                } 
                // 2. Secondary: Actual Teams Environment
                else if (window.microsoftTeams && window.microsoftTeams.app) {
                    try {
                        await microsoftTeams.app.initialize();
                        const context = await microsoftTeams.app.getContext();
                        
                        // If we reach here, we are truly inside a Teams client
                        isInTeams = true;
                        const user = context.user || {};
                        const upn = user.userPrincipalName || user.loginHint || '';

                        if (upn.toLowerCase().endsWith(ALLOWED_DOMAIN.toLowerCase())) {
                            isAuthenticated = true;
                            currentUserEmail = upn;
                            currentUserDisplayName = user.displayName || upn.split('@')[0];
                            currentUserId = user.id || '';
                        } else {
                            isAuthenticated = false;
                        }
                    } catch (teamsError) {
                        console.warn('Teams SDK present but initialization failed. Likely a standard browser.');
                        setUnauthenticated();
                    }
                } 
                // 3. Final Fallback: Public Web
                else {
                    setUnauthenticated();
                }
            } catch (error) {
                console.error('Auth Error:', error);
                setUnauthenticated();
            }

            authChecked = true;
            updateAuthUI();
        }

        function setUnauthenticated() {
            isInTeams = false;
            isAuthenticated = false;
            currentUserEmail = null;
            currentUserDisplayName = null;
            currentUserId = null;
        }

        function updateAuthUI() {
            const loadingScreen = document.getElementById('loadingScreen');
            const teamsRequiredScreen = document.getElementById('teamsRequiredScreen');
            const accessDeniedScreen = document.getElementById('accessDeniedScreen');
            const mainApp = document.getElementById('mainApp');
            
            if (loadingScreen) loadingScreen.style.display = 'none';
            if (teamsRequiredScreen) teamsRequiredScreen.style.display = 'none';
            if (accessDeniedScreen) accessDeniedScreen.style.display = 'none';
            if (mainApp) mainApp.style.display = 'none';
            
            if (!authChecked) {
                if (loadingScreen) loadingScreen.style.display = 'flex';
            } else if (!isInTeams && !isAuthenticated) {
                if (teamsRequiredScreen) teamsRequiredScreen.style.display = 'flex';
            } else if (!isAuthenticated) {
                if (accessDeniedScreen) {
                    accessDeniedScreen.style.display = 'flex';
                    const deniedEmail = document.getElementById('deniedEmail');
                    if (deniedEmail && currentUserEmail) {
                        deniedEmail.textContent = currentUserEmail;
                    }
                }
            } else {
                if (mainApp) {
                    mainApp.style.display = 'block';
                    const userInfo = document.getElementById('userInfo');
                    if (userInfo && currentUserDisplayName) {
                        userInfo.innerHTML = `Signed in as<br><strong>${currentUserDisplayName}</strong>`;
                    }
                }
            }
        }

        // Run authentication check on load
        checkAuthentication();

        // ============================================================================
        // NAVIGATION
        // ============================================================================
        function showView(viewName) {
            document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));

            if (viewName === 'home') {
                document.getElementById('homeView').classList.add('active');
                document.querySelector('.nav-tab').classList.add('active');
            } else if (viewName === 'refer') {
                document.getElementById('referView').classList.add('active');
                document.getElementById('referTab').classList.add('active');
                initReferralView();
            } else if (viewName === 'meeting') {
                document.getElementById('meetingView').classList.add('active');
                document.getElementById('meetingTab').classList.add('active');
                initMeetingView();
            } else if (viewName === 'outcomes') {
                document.getElementById('outcomesView').classList.add('active');
                document.getElementById('outcomesTab').classList.add('active');
                loadOutcomes();
            }
        }

        // ============================================================================
        // API CALLS
        // ============================================================================
        async function apiCall(baseUrl, action, method = 'GET', data = null) {
            const needsKey = (baseUrl || '').includes('apReferral.php');
            const keyParam = (needsKey && AP_REFERRAL_API_KEY) ? `&key=${encodeURIComponent(AP_REFERRAL_API_KEY)}` : '';
            const url = `${baseUrl}?action=${action}${keyParam}`;
            const options = { method: method, headers: {} };

            // IMPORTANT (CORS): Avoid preflight by using a "simple request" for POST/PATCH/DELETE.
            // - method: GET/POST are simple; PATCH triggers preflight in many browsers.
            // - header: Content-Type must be text/plain (or form-encoded/multipart) to stay simple.
            // We send JSON as text/plain; PHP can still json_decode(php://input).
            if (method !== 'GET') {
                options.headers['Content-Type'] = 'text/plain;charset=UTF-8';
                options.body = JSON.stringify(data || {});
            }

            try {
                const response = await fetch(url, options);
                const raw = await response.text();
                let result = null;
                try { result = raw ? JSON.parse(raw) : null; } catch (_) { result = null; }
                
                if (!response.ok) {
                    const msg = (result && (result.error || result.message))
                        ? (result.error || result.message)
                        : (raw || `API request failed (HTTP ${response.status})`);
                    throw new Error(msg);
                }
                
                return result || {};
            } catch (error) {
                console.error('API call error:', error);
                throw error;
            }
        }

        function formatDomainsAndIssuesByDomain(conditionsByDomain) {
            const lines = [];

            for (const domain of Object.keys(DOMAINS_AND_CONDITIONS)) {
                const conds = conditionsByDomain?.[domain];
                if (!Array.isArray(conds) || conds.length === 0) continue;

                lines.push(`${domain}:`);
                for (const c of conds) {
                    lines.push(c);
                }
                lines.push(''); // blank line between domains
            }

            return lines.join('\n').trim();
        }

        function parseDomainsAndIssuesText(text) {
            // Input is plain text like:
            // Domain:
            // Condition
            // Condition
            // (blank line)
            if (!text || typeof text !== 'string') return [];

            const lines = text.split(/\r?\n/).map(l => l.trimEnd());
            const result = [];
            let current = null;

            for (const raw of lines) {
                const line = raw.trim();
                if (!line) continue;

                if (line.endsWith(':')) {
                    current = { domain: line.slice(0, -1), conditions: [] };
                    result.push(current);
                    continue;
                }
                if (!current) {
                    // If the stored text isn't formatted, treat as a single domain-less list
                    current = { domain: 'Domains & Issues', conditions: [] };
                    result.push(current);
                }
                current.conditions.push(line);
            }

            return result;
        }

        // ============================================================================
        // REFERRAL VIEW - Step 1: Select Students
        // ============================================================================
        function initReferralView() {
            // Reset to step 1
            showStep(1);
            selectedStudents = {};
            studentConditions = {};
            studentStrengths = {};
            studentPreferredSubjects = {};
            studentTriggerSubjects = {};
            conditionsSearch = '';
            const searchEl = document.getElementById('conditionsSearch');
            if (searchEl) searchEl.value = '';
            loadClasses();
        }

        async function loadClasses() {
            const container = document.getElementById('classTabsContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading classes...</div>';

            try {
                const result = await apiCall(LISTS_API_BASE_URL, 'classes');
                classes = result.classes || [];
                renderClassTabs();
            } catch (error) {
                container.innerHTML = `<div class="empty-state"><p>Error loading classes: ${error.message}</p></div>`;
            }
        }

        function renderClassTabs() {
            const container = document.getElementById('classTabsContainer');
            
            if (classes.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No classes found</p></div>';
                return;
            }

            // Sort classes by name
            classes.sort((a, b) => {
                const nameA = a.crd88_classid || '';
                const nameB = b.crd88_classid || '';
                return nameA.localeCompare(nameB);
            });

            container.innerHTML = classes.map(cls => `
                <button class="class-tab ${selectedClass === cls.crd88_classesid ? 'active' : ''}" 
                        onclick="selectClass('${cls.crd88_classesid}')">
                    ${cls.crd88_classid || 'Unknown Class'}
                </button>
            `).join('');
        }

        async function selectClass(classId) {
            selectedClass = classId;
            renderClassTabs();
            await loadStudents(classId);
        }

        async function loadStudents(classId) {
            const container = document.getElementById('studentListContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading students...</div>';

            try {
                const result = await apiCall(LISTS_API_BASE_URL, `students&classId=${classId}`);
                students = result.students || [];
                renderStudentList();
            } catch (error) {
                container.innerHTML = `<div class="empty-state"><p>Error loading students: ${error.message}</p></div>`;
            }
        }

        function renderStudentList() {
            const container = document.getElementById('studentListContainer');
            
            if (students.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No students found in this class</p></div>';
                return;
            }

            // Sort students by name
            students.sort((a, b) => {
                const nameA = a.new_fullname || '';
                const nameB = b.new_fullname || '';
                return nameA.localeCompare(nameB);
            });

            container.innerHTML = `
                <div class="student-list">
                    ${students.map(student => {
                        const isSelected = selectedStudents[student.new_studentsid] !== undefined;
                        return `
                            <div class="student-item ${isSelected ? 'selected' : ''}" 
                                 onclick="toggleStudent('${student.new_studentsid}')">
                                <input type="checkbox" 
                                       id="student-${student.new_studentsid}" 
                                       ${isSelected ? 'checked' : ''}
                                       onclick="event.stopPropagation(); toggleStudent('${student.new_studentsid}')">
                                <label for="student-${student.new_studentsid}">
                                    ${student.new_fullname || 'Unknown'}
                                    ${student.crd88_indexnumber ? `<br><small style="color: var(--colorNeutralForeground3);">${student.crd88_indexnumber}</small>` : ''}
                                </label>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function toggleStudent(studentId) {
            const student = students.find(s => s.new_studentsid === studentId);
            if (!student) return;

            if (selectedStudents[studentId]) {
                delete selectedStudents[studentId];
                delete studentConditions[studentId];
                delete studentStrengths[studentId];
                delete studentPreferredSubjects[studentId];
                delete studentTriggerSubjects[studentId];
            } else {
                selectedStudents[studentId] = student;
                studentConditions[studentId] = {};
                studentStrengths[studentId] = '';
                studentPreferredSubjects[studentId] = [];
                studentTriggerSubjects[studentId] = [];
            }

            renderStudentList();
            updateNextButton();
        }

        function updateNextButton() {
            const btn = document.getElementById('nextToStep2Btn');
            const selectedCount = Object.keys(selectedStudents).length;
            btn.disabled = selectedCount === 0;
            btn.textContent = selectedCount > 0 
                ? `Next: Select Conditions (${selectedCount} student${selectedCount > 1 ? 's' : ''})` 
                : 'Next: Select Conditions';
        }

        // ============================================================================
        // REFERRAL VIEW - Step 2: Select Conditions
        // ============================================================================
        function goToStep2() {
            if (Object.keys(selectedStudents).length === 0) {
                showStatus('Please select at least one student', 'error');
                return;
            }
            showStep(2);
            renderConditionsSelection();
        }

        function goToStep1() {
            showStep(1);
        }

        function renderConditionsSelection() {
            const container = document.getElementById('selectedStudentsContainer');
            
            container.innerHTML = Object.values(selectedStudents).map(student => `
                <div class="selected-student-card">
                    <div class="student-name-column">
                        <h4>${student.new_fullname || 'Unknown Student'}</h4>
                        ${student.crd88_indexnumber ? `<p style="margin: var(--spacing-xs) 0 0 0; color: var(--colorNeutralForeground3); font-size: var(--fontSizeSmall);">${student.crd88_indexnumber}</p>` : ''}
                    </div>
                    <div class="conditions-column">

                        <div class="form-group" style="margin-bottom: var(--spacing-l);">
                            <label for="strengths-${student.new_studentsid}">Strengths</label>
                            <textarea
                                id="strengths-${student.new_studentsid}"
                                class="form-control short"
                                rows="2"
                                placeholder="Enter student strengths..."
                                oninput="setStudentStrength('${student.new_studentsid}', this.value)"
                            >${escapeHtml(studentStrengths[student.new_studentsid] || '')}</textarea>
                        </div>

                        <div class="form-group" style="margin-bottom: var(--spacing-l);">
                            <label>Preferred Subjects</label>
                            <div style="display:flex; flex-wrap: wrap; gap: var(--spacing-s); margin-top: var(--spacing-xs);">
                                ${SUBJECT_OPTIONS.map((subj, subjIndex) => {
                                    const checked = (studentPreferredSubjects[student.new_studentsid] || []).includes(subj);
                                    const id = `prefsubj-${student.new_studentsid}-${subj.replace(/\\s+/g,'-')}`;
                                    return `
                                        <label for="${id}" style="display:flex; align-items:center; gap: 8px; padding: 6px 10px; border: 1px solid var(--colorNeutralStroke2); border-radius: 999px; background: ${checked ? 'rgba(16,124,16,0.08)' : 'var(--colorNeutralBackground1)'}; cursor: pointer;">
                                            <input id="${id}" type="checkbox" ${checked ? 'checked' : ''} onchange="toggleStudentPreferredSubjectByIndex('${student.new_studentsid}', ${subjIndex}, this.checked)" />
                                            <span style="font-size: var(--fontSizeSmall);">${subj}</span>
                                        </label>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <div class="form-group" style="margin-bottom: var(--spacing-l);">
                            <label>Trigger Subjects</label>
                            <div style="display:flex; flex-wrap: wrap; gap: var(--spacing-s); margin-top: var(--spacing-xs);">
                                ${SUBJECT_OPTIONS.map((subj, subjIndex) => {
                                    const checked = (studentTriggerSubjects[student.new_studentsid] || []).includes(subj);
                                    const id = `trigsubj-${student.new_studentsid}-${subj.replace(/\\s+/g,'-')}`;
                                    return `
                                        <label for="${id}" style="display:flex; align-items:center; gap: 8px; padding: 6px 10px; border: 1px solid var(--colorNeutralStroke2); border-radius: 999px; background: ${checked ? 'rgba(196,43,28,0.08)' : 'var(--colorNeutralBackground1)'}; cursor: pointer;">
                                            <input id="${id}" type="checkbox" ${checked ? 'checked' : ''} onchange="toggleStudentTriggerSubjectByIndex('${student.new_studentsid}', ${subjIndex}, this.checked)" />
                                            <span style="font-size: var(--fontSizeSmall);">${subj}</span>
                                        </label>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Domains &amp; Issues</label>
                            ${renderDomainGroups(student.new_studentsid, conditionsSearch)}
                        </div>
                    </div>
                </div>
            `).join('');

            updateStep3Button();
        }

        function setStudentStrength(studentId, value) {
            studentStrengths[studentId] = value || '';
        }

        function toggleStudentPreferredSubjectByIndex(studentId, subjectIndex, isChecked) {
            const subject = SUBJECT_OPTIONS[subjectIndex];
            if (!subject) return;

            const current = Array.isArray(studentPreferredSubjects[studentId]) ? studentPreferredSubjects[studentId] : [];
            if (isChecked) {
                if (!current.includes(subject)) current.push(subject);
            } else {
                studentPreferredSubjects[studentId] = current.filter(s => s !== subject);
                return;
            }
            studentPreferredSubjects[studentId] = current;
        }

        function toggleStudentTriggerSubjectByIndex(studentId, subjectIndex, isChecked) {
            const subject = SUBJECT_OPTIONS[subjectIndex];
            if (!subject) return;

            const current = Array.isArray(studentTriggerSubjects[studentId]) ? studentTriggerSubjects[studentId] : [];
            if (isChecked) {
                if (!current.includes(subject)) current.push(subject);
            } else {
                studentTriggerSubjects[studentId] = current.filter(s => s !== subject);
                return;
            }
            studentTriggerSubjects[studentId] = current;
        }

        function normalizeSearchTerm(term) {
            return (term || '').trim().toLowerCase();
        }

        function setConditionsSearch(value) {
            conditionsSearch = value || '';
            renderConditionsSelection();
        }

        function renderDomainGroups(studentId, searchTermRaw) {
            const searchTerm = normalizeSearchTerm(searchTermRaw);
            const forceExpand = searchTerm.length > 0;

            return Object.entries(DOMAINS_AND_CONDITIONS).map(([domain, conditions]) => {
                const filtered = !searchTerm
                    ? conditions
                    : conditions.filter(c => c.toLowerCase().includes(searchTerm));

                const headerCollapsedClass = forceExpand ? '' : 'collapsed';
                const conditionsCollapsedClass = forceExpand ? '' : 'collapsed';

                const conditionsHtml = filtered.length
                    ? filtered.map((condition) => {
                        const idx = conditions.indexOf(condition);
                        const isChecked = studentConditions[studentId]?.[domain]?.includes(condition);
                        return `
                            <div class="condition-item">
                                <input type="checkbox"
                                       id="cond-${studentId}-${domain}-${idx}"
                                       ${isChecked ? 'checked' : ''}
                                       onchange="toggleCondition('${studentId}', '${domain}', '${condition.replace(/'/g, "\\'")}')">
                                <label for="cond-${studentId}-${domain}-${idx}">${condition}</label>
                            </div>
                        `;
                    }).join('')
                    : (forceExpand ? `<div style="padding: var(--spacing-s); color: var(--colorNeutralForeground3); font-size: var(--fontSizeSmall);">No matches</div>` : '');

                return `
                <div class="domain-group">
                    <div class="domain-header ${headerCollapsedClass}" onclick="toggleDomain(this)">
                        <span>${domain}</span>
                        <span class="toggle-icon"></span>
                    </div>
                    <div class="domain-conditions ${conditionsCollapsedClass}">
                        ${conditionsHtml}
                    </div>
                </div>
                `;
            }).join('');
        }

        function toggleDomain(header) {
            header.classList.toggle('collapsed');
            const conditions = header.nextElementSibling;
            conditions.classList.toggle('collapsed');
        }

        function toggleCondition(studentId, domain, condition) {
            if (!studentConditions[studentId]) {
                studentConditions[studentId] = {};
            }
            if (!studentConditions[studentId][domain]) {
                studentConditions[studentId][domain] = [];
            }

            const conditions = studentConditions[studentId][domain];
            const index = conditions.indexOf(condition);
            
            if (index > -1) {
                conditions.splice(index, 1);
            } else {
                conditions.push(condition);
            }

            // Clean up empty arrays
            if (conditions.length === 0) {
                delete studentConditions[studentId][domain];
            }
            if (Object.keys(studentConditions[studentId]).length === 0) {
                delete studentConditions[studentId];
            }

            updateStep3Button();
        }

        function updateStep3Button() {
            const btn = document.getElementById('nextToStep3Btn');
            // Check if at least one student has at least one condition selected
            const hasConditions = Object.values(studentConditions).some(domains => 
                Object.values(domains).some(conditions => conditions.length > 0)
            );
            btn.disabled = !hasConditions;
        }

        // ============================================================================
        // REFERRAL VIEW - Step 3: Review & Submit
        // ============================================================================
        function goToStep3() {
            showStep(3);
            renderReview();
        }

        function goToStep2FromReview() {
            showStep(2);
        }

        function renderReview() {
            const container = document.getElementById('reviewContainer');
            
            const reviews = Object.entries(selectedStudents).map(([studentId, student]) => {
                const conditions = studentConditions[studentId] || {};
                const strengths = (studentStrengths[studentId] || '').trim();
                const preferredSubjects = Array.isArray(studentPreferredSubjects[studentId]) ? studentPreferredSubjects[studentId].filter(Boolean) : [];
                const triggerSubjects = Array.isArray(studentTriggerSubjects[studentId]) ? studentTriggerSubjects[studentId].filter(Boolean) : [];
                const conditionsList = Object.entries(conditions)
                    .filter(([_, conds]) => conds.length > 0)
                    .map(([domain, conds]) => `
                        <div style="margin-bottom: var(--spacing-s);">
                            <strong>${domain}:</strong>
                            <ul style="margin: var(--spacing-xs) 0 0 var(--spacing-l); padding: 0;">
                                ${conds.map(c => `<li>${c}</li>`).join('')}
                            </ul>
                        </div>
                    `).join('');

                return `
                    <div class="selected-student-card">
                        <h4 style="margin-right: var(--spacing-xxl);">${student.new_fullname || 'Unknown Student'}</h4>

                        <div style="margin: var(--spacing-s) 0;">
                            <strong>Strengths:</strong>
                            <div style="margin-top: var(--spacing-xs);">
                                ${strengths ? escapeHtml(strengths) : '<span style="color: var(--colorNeutralForeground3);"></span>'}
                            </div>
                        </div>

                        <div style="margin: var(--spacing-s) 0;">
                            <strong>Preferred Subjects:</strong>
                            <div style="margin-top: var(--spacing-xs); color: ${preferredSubjects.length ? 'inherit' : 'var(--colorNeutralForeground3)'};">
                                ${preferredSubjects.length ? preferredSubjects.map(s => escapeHtml(String(s))).join(', ') : ''}
                            </div>
                        </div>

                        <div style="margin: var(--spacing-s) 0;">
                            <strong>Trigger Subjects:</strong>
                            <div style="margin-top: var(--spacing-xs); color: ${triggerSubjects.length ? 'inherit' : 'var(--colorNeutralForeground3)'};">
                                ${triggerSubjects.length ? triggerSubjects.map(s => escapeHtml(String(s))).join(', ') : ''}
                            </div>
                        </div>

                        <div style="margin: var(--spacing-s) 0;">
                            <strong>Domains &amp; Issues:</strong>
                            <div style="margin-top: var(--spacing-xs);">
                                ${conditionsList || '<span style="color: var(--colorNeutralForeground3);">No conditions selected</span>'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = reviews;
        }

        async function submitReferrals() {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                const referrals = [];
                
                for (const [studentId, student] of Object.entries(selectedStudents)) {
                    const conditions = studentConditions[studentId] || {};
                    
                    const domainsAndIssues = formatDomainsAndIssuesByDomain(conditions);
                    if (domainsAndIssues) {
                        referrals.push({
                            studentId: studentId,
                            studentName: student.new_fullname,
                            domainsAndIssues,
                            strengths: (studentStrengths[studentId] || '').trim(),
                            preferredSubjects: studentPreferredSubjects[studentId] || [],
                            triggerSubjects: studentTriggerSubjects[studentId] || [],
                            referredBy: currentUserEmail,
                            referredByName: currentUserDisplayName
                        });
                    }
                }

                if (referrals.length === 0) {
                    showStatus('No conditions selected for any student', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Referrals';
                    return;
                }

                const result = await apiCall(REFERRAL_API_BASE_URL, 'submitReferrals', 'POST', { referrals });
                
                if (result.success) {
                    showStatus(`Successfully submitted ${referrals.length} referral(s)!`, 'success');
                    
                    // Reset and go back to home
                    setTimeout(() => {
                        selectedStudents = {};
                        studentConditions = {};
                        studentStrengths = {};
                        studentPreferredSubjects = {};
                        studentTriggerSubjects = {};
                        showView('home');
                        hideStatus();
                    }, 2000);
                } else {
                    throw new Error(result.error || 'Failed to submit referrals');
                }
            } catch (error) {
                showStatus(`Error submitting referrals: ${error.message}`, 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Referrals';
            }
        }

        // ============================================================================
        // STEPPER UI
        // ============================================================================
        function showStep(stepNumber) {
            // Hide all steps
            document.getElementById('referStep1').style.display = 'none';
            document.getElementById('referStep2').style.display = 'none';
            document.getElementById('referStep3').style.display = 'none';

            // Show selected step
            document.getElementById(`referStep${stepNumber}`).style.display = 'block';

            // Update stepper UI
            for (let i = 1; i <= 3; i++) {
                const step = document.getElementById(`step${i}`);
                const connector = document.getElementById(`connector${i}`);
                
                step.classList.remove('active', 'completed');
                if (connector) connector.classList.remove('completed');
                
                if (i < stepNumber) {
                    step.classList.add('completed');
                    if (connector) connector.classList.add('completed');
                } else if (i === stepNumber) {
                    step.classList.add('active');
                }
            }
        }

        // ============================================================================
        // OUTCOMES VIEW - Review Action Plans by Student
        // ============================================================================
        let outcomesPendingStudents = []; // { studentId, studentName, refId, referralId, actionPlans: [...] }
        let outcomesCompletedStudents = []; // same structure
        let outcomesActiveStudent = null; // currently selected student
        let outcomesActiveGoal = null; // currently selected goal for review modal
        let outcomesAllActionPlans = []; // raw action plans from API

        function formatDateForDisplay(iso) {
            if (!iso) return '-';
            const d = new Date(iso);
            if (Number.isNaN(d.getTime())) return '-';
            return d.toLocaleDateString();
        }

        function setSwitchValue(id, valueBoolOrNull) {
            const el = document.getElementById(id);
            if (!el) return;
            if (valueBoolOrNull === null || valueBoolOrNull === undefined) {
                el.checked = false;
                return;
            }
            el.checked = !!valueBoolOrNull;
        }

        function getSwitchValue(id) {
            const el = document.getElementById(id);
            if (!el) return null;
            return !!el.checked;
        }

        function isReviewDateDue(reviewDate) {
            if (!reviewDate) return false;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const review = new Date(reviewDate);
            review.setHours(0, 0, 0, 0);
            return review <= today;
        }

        async function loadOutcomes() {
            const pendingContainer = document.getElementById('pendingOutcomesContainer');
            const completedContainer = document.getElementById('completedOutcomesContainer');
            pendingContainer.innerHTML = '<div class="loading"><div class="spinner"></div>Loading pending reviews...</div>';
            completedContainer.innerHTML = '<div class="loading"><div class="spinner"></div>Loading completed reviews...</div>';

            try {
                // Fetch action plans that are due for review (reviewDate <= today)
                const response = await apiCall(REFERRAL_API_BASE_URL, 'actionPlansForReview');
                outcomesAllActionPlans = response.actionPlans || [];

                // Group action plans by student
                const pendingMap = {}; // studentId -> { studentInfo, actionPlans }
                const completedMap = {};

                for (const ap of outcomesAllActionPlans) {
                    const studentId = ap.studentId || ap._crd88_new_students_value || '';
                    const studentName = ap.studentName || ap.studentFullName || 'Unknown';
                    const refId = ap.refId || ap.crd88_refid || '';
                    const referralId = ap.referralId || ap.crd88_referraltoapid || '';
                    const goalId = ap.goalId || ap.crd88_goalid || '';
                    const goalText = ap.goalText || ap.crd88_goal || '';
                    const actionPlanStatus = Number(ap.status ?? ap.crd88_actionplanstatus ?? 5);
                    const goalCompleted = ap.goalCompleted ?? ap.crd88_completed ?? 0; // kept for display only
                    const goalCompletionNotes = ap.goalCompletionNotes || ap.crd88_completionnotes || '';
                    const actionPlanDetails = ap.actionPlanDetails || ap.crd88_actionplandetails || '';
                    const actionBy = ap.actionBy || ap.crd88_actionby || '';
                    const reviewDate = ap.reviewDate || ap.crd88_reviewdate || null;
                    const actionPlanId = ap.actionPlanId || ap.crd88_actionplanid || '';

                    if (!studentId) continue;

                    const apData = {
                        actionPlanId,
                        goalId,
                        goalText,
                        actionPlanStatus,
                        goalCompleted: Number(goalCompleted) === 1,
                        goalCompletionNotes,
                        actionPlanDetails,
                        actionBy,
                        reviewDate,
                        studentId,
                        studentName,
                        refId,
                        referralId
                    };

                    // Split by goal completion (completed goals should move out of pending + not be overdue)
                    const targetMap = apData.goalCompleted ? completedMap : pendingMap;

                    if (!targetMap[studentId]) {
                        targetMap[studentId] = {
                            studentId,
                            studentName,
                            refId,
                            referralId,
                            actionPlans: []
                        };
                    }
                    targetMap[studentId].actionPlans.push(apData);
                }

                // Convert maps to arrays
                outcomesPendingStudents = Object.values(pendingMap);
                outcomesCompletedStudents = Object.values(completedMap);

                // Sort by student name
                outcomesPendingStudents.sort((a, b) => (a.studentName || '').localeCompare(b.studentName || ''));
                outcomesCompletedStudents.sort((a, b) => (a.studentName || '').localeCompare(b.studentName || ''));

                // Update counts
                document.getElementById('pendingCount').textContent = `${outcomesPendingStudents.length}`;
                document.getElementById('completedCount').textContent = `${outcomesCompletedStudents.length}`;

                renderOutcomesStudentsList();
            } catch (error) {
                pendingContainer.innerHTML = `<div class="empty-state"><p>Error loading: ${error.message}</p></div>`;
                completedContainer.innerHTML = `<div class="empty-state"><p>Error loading: ${error.message}</p></div>`;
            }
        }

        function renderOutcomesStudentsList() {
            const pendingContainer = document.getElementById('pendingOutcomesContainer');
            const completedContainer = document.getElementById('completedOutcomesContainer');

            // Pending students
            if (!outcomesPendingStudents.length) {
                pendingContainer.innerHTML = `<div class="empty-state"><p>No pending reviews</p></div>`;
            } else {
                const rows = outcomesPendingStudents.map(s => {
                    const pendingCount = s.actionPlans.filter(ap => !ap.goalCompleted).length;
                    const overdueCount = s.actionPlans.filter(ap => !ap.goalCompleted && isReviewDateDue(ap.reviewDate)).length;
                    
                    return `
                        <div class="outcomes-student-card" onclick="openOutcomesStudentModal('${s.studentId}', 'pending')">
                            <div class="outcomes-student-info">
                                <div class="outcomes-student-name">${escapeHtml(s.studentName)}</div>
                                <div class="outcomes-student-meta">
                                    ${s.refId ? `Ref: ${escapeHtml(s.refId)}` : ''}
                                    ${pendingCount > 0 ? `  ${pendingCount} action plan${pendingCount !== 1 ? 's' : ''}` : ''}
                                </div>
                            </div>
                            ${overdueCount > 0 ? `<span class="outcomes-badge warning">${overdueCount} overdue</span>` : ''}
                            <div style="color: var(--colorNeutralForeground3);">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </div>
                        </div>
                    `;
                }).join('');
                pendingContainer.innerHTML = `<div style="display: grid; gap: var(--spacing-s);">${rows}</div>`;
            }

            // Completed students
            if (!outcomesCompletedStudents.length) {
                completedContainer.innerHTML = `<div class="empty-state"><p>No completed reviews</p></div>`;
            } else {
                const rows = outcomesCompletedStudents.map(s => {
                    const completedCount = s.actionPlans.filter(ap => ap.goalCompleted).length;
                    
                    return `
                        <div class="outcomes-student-card" onclick="openOutcomesStudentModal('${s.studentId}', 'completed')">
                            <div class="outcomes-student-info">
                                <div class="outcomes-student-name">${escapeHtml(s.studentName)}</div>
                                <div class="outcomes-student-meta">
                                    ${s.refId ? `Ref: ${escapeHtml(s.refId)}` : ''}
                                    ${completedCount > 0 ? `  ${completedCount} completed action plan${completedCount !== 1 ? 's' : ''}` : ''}
                                </div>
                            </div>
                            <span class="outcomes-badge success">${completedCount} done</span>
                            <div style="color: var(--colorNeutralForeground3);">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </div>
                        </div>
                    `;
                }).join('');
                completedContainer.innerHTML = `<div style="display: grid; gap: var(--spacing-s);">${rows}</div>`;
            }
        }

        function openOutcomesStudentModal(studentId, mode) {
            // Find student in either pending or completed
            const student = mode === 'pending' 
                ? outcomesPendingStudents.find(s => s.studentId === studentId)
                : outcomesCompletedStudents.find(s => s.studentId === studentId);
            
            if (!student) return;

            outcomesActiveStudent = { ...student, mode };

            // Update modal header
            document.getElementById('outcomesStudentModalName').textContent = student.studentName || 'Student';
            document.getElementById('outcomesStudentModalRefId').textContent = student.refId || '';

            // Populate referral summary (from crd88_referraltoaps table)
            loadOutcomesReferralSummary();

            // Render action plans list
            renderOutcomesActionPlansList();

            document.getElementById('outcomesStudentModal').style.display = 'block';
        }

        async function loadOutcomesReferralSummary() {
            const strengthsEl = document.getElementById('outcomesStudentModalStrengths');
            const domainsEl = document.getElementById('outcomesStudentModalDomains');
            const notesEl = document.getElementById('outcomesStudentModalMeetingNotes');

            if (strengthsEl) strengthsEl.textContent = 'Loading';
            if (domainsEl) domainsEl.textContent = 'Loading';
            if (notesEl) { notesEl.textContent = 'Loading'; }

            const referralId = outcomesActiveStudent?.referralId || outcomesActiveStudent?.actionPlans?.[0]?.referralId || null;
            if (!referralId) {
                if (strengthsEl) strengthsEl.textContent = '';
                if (domainsEl) domainsEl.textContent = '';
                if (notesEl) { notesEl.textContent = ''; }
                return;
            }

            let referral = null;
            try {
                const res = await apiCall(REFERRAL_API_BASE_URL, `getReferral&referralId=${encodeURIComponent(referralId)}`);
                referral = res?.referral || null;
            } catch (_) {
                referral = null;
            }

            const strengths = (referral?.crd88_strengths || '').toString().trim();
            const domainsText = (referral?.crd88_domainsandconditions || '').toString();
            const meetingNotes = (referral?.crd88_meetingnotes || '').toString().trim();

            if (strengthsEl) strengthsEl.textContent = strengths || '';
            if (notesEl) {
                notesEl.textContent = meetingNotes || '';
                notesEl.className = meetingNotes ? 'domains-empty' : 'domains-empty muted';
            }

            if (!domainsEl) return;
            const parsed = parseDomainsAndIssuesText(domainsText);
            if (!parsed.length) {
                domainsEl.textContent = '';
                return;
            }
            domainsEl.innerHTML = parsed.map(d => `
                <div style="margin-bottom: var(--spacing-m);">
                    <div style="font-weight: var(--fontWeightSemibold); color: var(--colorBrandBackground); margin-bottom: var(--spacing-xs);">${escapeHtml(d.domain)}:</div>
                    <div style="padding-left: var(--spacing-m);">
                        ${d.conditions.map(c => `<div style="margin: 2px 0;">${escapeHtml(c)}</div>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        function renderOutcomesActionPlansList() {
            const container = document.getElementById('outcomesStudentModalActionPlans');
            if (!outcomesActiveStudent) {
                container.innerHTML = '<div class="empty-state"><p>No data</p></div>';
                return;
            }

            const actionPlans = outcomesActiveStudent.actionPlans || [];
            if (!actionPlans.length) {
                container.innerHTML = '<div class="empty-state"><p>No action plans found</p></div>';
                return;
            }

            // Sort: overdue first, then by date
            const sorted = [...actionPlans].sort((a, b) => {
                // Completed items go last
                if (a.goalCompleted !== b.goalCompleted) return a.goalCompleted ? 1 : -1;
                // Then by whether overdue
                const aOverdue = isReviewDateDue(a.reviewDate);
                const bOverdue = isReviewDateDue(b.reviewDate);
                if (aOverdue !== bOverdue) return aOverdue ? -1 : 1;
                // Then by date
                return new Date(a.reviewDate || 0) - new Date(b.reviewDate || 0);
            });

            const rows = sorted.map(ap => {
                const isOverdue = !ap.goalCompleted && isReviewDateDue(ap.reviewDate);
                const isCompleted = ap.goalCompleted;

                // Warning icon SVG
                const warningIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>`;

                // Check/tick icon SVG
                const checkIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>`;

                // Chevron icon
                const chevronIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>`;

                return `
                    <div class="action-plan-review-item ${isCompleted ? 'completed' : ''}" onclick="openGoalReviewModal('${ap.goalId}', '${ap.actionPlanId}')">
                        <div class="action-plan-icon ${isOverdue ? 'warning' : ''} ${isCompleted ? 'success' : ''}">
                            ${isCompleted ? checkIcon : (isOverdue ? warningIcon : '')}
                        </div>
                        <div class="action-plan-content">
                            <div class="action-plan-goal">${escapeHtml(ap.goalText || 'No goal text')}</div>
                            <div class="action-plan-details">${escapeHtml(ap.actionPlanDetails || 'No action plan details')}</div>
                            <div class="action-plan-meta">
                                <span>Action by: ${escapeHtml(ap.actionBy || '')}</span>
                                <span>Review: ${formatDateForDisplay(ap.reviewDate)}</span>
                            </div>
                        </div>
                        <div class="action-plan-chevron">${chevronIcon}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = rows;
        }

        function closeOutcomesStudentModal() {
            const modal = document.getElementById('outcomesStudentModal');
            if (modal) modal.style.display = 'none';
            outcomesActiveStudent = null;
        }

        function openGoalReviewModal(goalId, actionPlanId) {
            // Find the action plan data
            const ap = outcomesActiveStudent?.actionPlans?.find(
                a => String(a.goalId) === String(goalId) && String(a.actionPlanId) === String(actionPlanId)
            );
            if (!ap) return;

            outcomesActiveGoal = { ...ap };

            // Populate modal fields
            document.getElementById('goalReviewModalGoalText').textContent = ap.goalText || '';
            document.getElementById('goalReviewModalActionPlanText').textContent = ap.actionPlanDetails || '';
            document.getElementById('goalReviewModalActionBy').textContent = ap.actionBy || '';
            document.getElementById('goalReviewModalReviewDate').textContent = formatDateForDisplay(ap.reviewDate);

            // Set switch value
            setSwitchValue('goalReviewCompletedSwitch', ap.goalCompleted);
            document.getElementById('goalReviewNotes').value = ap.goalCompletionNotes || '';

            // Clear status
            const status = document.getElementById('goalReviewModalStatus');
            if (status) { status.className = 'status'; status.textContent = ''; }

            document.getElementById('goalReviewModal').style.display = 'block';
        }

        function closeGoalReviewModal() {
            const modal = document.getElementById('goalReviewModal');
            if (modal) modal.style.display = 'none';
            outcomesActiveGoal = null;
        }

        async function saveGoalReview() {
            if (!outcomesActiveGoal) return;

            const btn = document.getElementById('goalReviewSaveBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            const completed = getSwitchValue('goalReviewCompletedSwitch');
            const completionNotes = (document.getElementById('goalReviewNotes').value || '').trim();

            try {
                // Call API to update goal completion status
                await apiCall(REFERRAL_API_BASE_URL, 'updateGoalCompletion', 'POST', {
                    goalId: outcomesActiveGoal.goalId,
                    completed: !!completed,
                    completionNotes
                });

                // Update local state
                outcomesActiveGoal.goalCompleted = completed;
                outcomesActiveGoal.goalCompletionNotes = completionNotes;

                // Update in the student's action plans array
                if (outcomesActiveStudent) {
                    const idx = outcomesActiveStudent.actionPlans.findIndex(
                        a => String(a.goalId) === String(outcomesActiveGoal.goalId) && 
                             String(a.actionPlanId) === String(outcomesActiveGoal.actionPlanId)
                    );
                    if (idx !== -1) {
                        outcomesActiveStudent.actionPlans[idx].goalCompleted = completed;
                        outcomesActiveStudent.actionPlans[idx].goalCompletionNotes = completionNotes;
                    }
                }

                // Re-render the action plans list in the student modal
                renderOutcomesActionPlansList();

                // If goal is now completed and was in pending, we may need to move student
                // Refresh the full view data to properly categorize
                await loadOutcomes();

                const status = document.getElementById('goalReviewModalStatus');
                status.textContent = 'Saved successfully!';
                status.className = 'status success';

                btn.disabled = false;
                btn.textContent = 'Save';

                // Close modal after a brief delay
                setTimeout(() => {
                    closeGoalReviewModal();
                    // Also close student modal if all goals are now complete
                    if (outcomesActiveStudent && outcomesActiveStudent.actionPlans.every(ap => ap.goalCompleted)) {
                        closeOutcomesStudentModal();
                    }
                }, 800);

            } catch (e) {
                const status = document.getElementById('goalReviewModalStatus');
                status.textContent = `Error saving: ${e.message}`;
                status.className = 'status error';
                btn.disabled = false;
                btn.textContent = 'Save';
            }
        }

        // ============================================================================
        // STUDENT SUPPORT MEETING
        // ============================================================================
        function initMeetingView() {
            meetingSelectedClass = null;
            meetingStudents = [];
            meetingStudentLatestCase = {};
            meetingActiveStudent = null;
            closeMeetingModal();
            loadMeetingClasses();
        }

        async function loadMeetingClasses() {
            const container = document.getElementById('meetingClassTabsContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading classes...</div>';

            try {
                const result = await apiCall(LISTS_API_BASE_URL, 'classes');
                meetingClasses = result.classes || [];

                meetingClasses.sort((a, b) => (a.crd88_classid || '').localeCompare(b.crd88_classid || ''));

                if (meetingClasses.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>No classes found</p></div>';
                    return;
                }

                container.innerHTML = meetingClasses.map(cls => `
                    <button class="class-tab ${meetingSelectedClass === cls.crd88_classesid ? 'active' : ''}"
                            onclick="selectMeetingClass('${cls.crd88_classesid}')">
                        ${cls.crd88_classid || 'Unknown Class'}
                    </button>
                `).join('');
            } catch (error) {
                container.innerHTML = `<div class="empty-state"><p>Error loading classes: ${error.message}</p></div>`;
            }
        }

        async function selectMeetingClass(classId) {
            meetingSelectedClass = classId;
            // re-render active state
            const container = document.getElementById('meetingClassTabsContainer');
            container.querySelectorAll('.class-tab').forEach(btn => btn.classList.remove('active'));
            const activeBtn = container.querySelector(`button[onclick=\"selectMeetingClass('${classId}')\"]`);
            if (activeBtn) activeBtn.classList.add('active');

            await loadMeetingStudents(classId);
        }

        async function loadMeetingStudents(classId) {
            const container = document.getElementById('meetingStudentsContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading students...</div>';

            try {
                const studentsResult = await apiCall(LISTS_API_BASE_URL, `students&classId=${classId}`);
                meetingStudents = studentsResult.students || [];

                if (meetingStudents.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>No students found in this class</p></div>';
                    return;
                }

                meetingStudents.sort((a, b) => (a.new_fullname || '').localeCompare(b.new_fullname || ''));

                // Load latest case for each student (only referrals will have a case)
                meetingStudentLatestCase = {};
                const casePromises = meetingStudents.map(async (s) => {
                    try {
                        const res = await apiCall(REFERRAL_API_BASE_URL, `latestReferralByStudent&studentId=${s.new_studentsid}`);
                        const referral = res?.referral;
                        if (referral) {
                            // Attach latest action plan (normalized) for filtering/prefill
                            try {
                                const rid = referral.crd88_referraltoapid || null;
                                if (rid) {
                                    const apRes = await apiCall(REFERRAL_API_BASE_URL, `latestActionPlanByReferral&referralId=${encodeURIComponent(rid)}`);
                                    referral.__actionPlanNormalized = apRes?.actionPlanNormalized || null;
                                    referral.__actionPlanId = apRes?.actionPlanNormalized?.actionPlanId || apRes?.actionPlan?.crd88_actionplanid || null;
                                }
                            } catch (_) {
                                // ignore
                            }
                            meetingStudentLatestCase[s.new_studentsid] = referral;
                        }
                    } catch (_) {
                        // ignore individual failures; student may have no case
                    }
                });

                // Render immediately, then update after cases load
                renderMeetingStudentsList();
                await Promise.all(casePromises);

                // Hide cases that already have a next review date (they move to Review Outcomes)
                for (const [sid, c] of Object.entries(meetingStudentLatestCase)) {
                    if (c?.__actionPlanNormalized?.reviewDate) delete meetingStudentLatestCase[sid];
                }

                renderMeetingStudentsList();
            } catch (error) {
                container.innerHTML = `<div class="empty-state"><p>Error loading students: ${error.message}</p></div>`;
            }
        }

        function renderMeetingStudentsList() {
            const container = document.getElementById('meetingStudentsContainer');

            if (!meetingStudents || meetingStudents.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Select a class to view students</p></div>';
                return;
            }

            const studentsWithCases = meetingStudents.filter(s => !!meetingStudentLatestCase[s.new_studentsid]);
            if (!studentsWithCases.length) {
                container.innerHTML = `<div class="empty-state"><p>No students pending meeting plans for this class.</p></div>`;
                return;
            }

            const rows = studentsWithCases.map(s => {
                const c = meetingStudentLatestCase[s.new_studentsid];
                const summary = (c?.crd88_domainsandconditions || '').split(/\r?\n/).slice(0, 4).join('  ');

                return `
                    <div class="student-item" onclick="openMeetingModal('${s.new_studentsid}')" style="cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="font-weight: var(--fontWeightSemibold); color: var(--colorNeutralForeground1);">
                                ${s.new_fullname || 'Unknown'}
                                ${s.crd88_indexnumber ? `<span style=\"color: var(--colorNeutralForeground3); font-weight: var(--fontWeightRegular);\"> (${s.crd88_indexnumber})</span>` : ''}
                            </div>
                            <div style="margin-top: var(--spacing-xs); color: var(--colorNeutralForeground2); font-size: var(--fontSizeSmall); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ${summary || 'Referral found (no details)'}
                            </div>
                        </div>
                        <div style="margin-left: var(--spacing-m); color: var(--colorNeutralForeground3); font-size: var(--fontSizeSmall);">Open</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div style="display: grid; gap: var(--spacing-s);">${rows}</div>`;
        }

        async function openMeetingModal(studentId) {
            const student = meetingStudents.find(s => s.new_studentsid === studentId);
            const referral = meetingStudentLatestCase[studentId];
            if (!student || !referral) return;

            meetingActiveStudent = { student, referral, actionPlanId: null };

            const nameEl = document.getElementById('meetingStudentName');
            if (nameEl) nameEl.textContent = student.new_fullname || 'Student';

            const refEl = document.getElementById('meetingStudentRefId');
            if (refEl) refEl.textContent = referral.crd88_refid || '';

            // Domains/conditions display (use stored formatted text)
            const domainsText = referral.crd88_domainsandconditions || '';
            const parsed = parseDomainsAndIssuesText(domainsText);
            const domainsDiv = document.getElementById('meetingModalDomains');

            if (!parsed.length) {
                domainsDiv.textContent = 'No domains/conditions recorded for this student.';
            } else {
                // Render with simple formatting while keeping copy/paste friendly
                domainsDiv.innerHTML = parsed.map(d => `
                    <div style="margin-bottom: var(--spacing-m);">
                        <div style="font-weight: var(--fontWeightSemibold); color: var(--colorBrandBackground); margin-bottom: var(--spacing-xs);">${d.domain}:</div>
                        <div style="padding-left: var(--spacing-m);">
                            ${d.conditions.map(c => `<div style="margin: 2px 0;">${escapeHtml(c)}</div>`).join('')}
                        </div>
                    </div>
                `).join('');
            }

            // Strengths
            const strengthsDiv = document.getElementById('meetingModalStrengths');
            if (strengthsDiv) {
                const strengths = (referral.crd88_strengths || '').trim();
                strengthsDiv.textContent = strengths || '';
                strengthsDiv.className = strengths ? 'domains-empty' : 'domains-empty';
            }

            // Subjects (preferred + trigger)
            const subjectsDiv = document.getElementById('meetingModalSubjects');
            if (subjectsDiv) {
                const parseNewlineList = (t) => String(t || '')
                    .split(/\r?\n/)
                    .map(s => s.trim())
                    .filter(Boolean);

                const preferred = parseNewlineList(referral.crd88_preferredsubjects);
                const trigger = parseNewlineList(referral.crd88_triggersubjects);

                if (!preferred.length && !trigger.length) {
                    subjectsDiv.textContent = '';
                    subjectsDiv.className = 'domains-empty';
                } else {
                    const rows = [
                        ...preferred.map(s => ({ type: 'preferred', label: s })),
                        ...trigger.map(s => ({ type: 'trigger', label: s })),
                    ];

                    subjectsDiv.className = 'domains-empty';
                    subjectsDiv.innerHTML = rows.map(r => `
                        <div style="display:flex; align-items:center; gap: 10px; margin: 4px 0;">
                            <span style="display:inline-flex; width: 18px; justify-content:center; font-weight: var(--fontWeightSemibold); color: ${r.type === 'preferred' ? 'var(--colorPaletteGreenForeground1)' : 'var(--colorPaletteRedForeground1)'};">
                                ${r.type === 'preferred' ? '' : ''}
                            </span>
                            <span>${escapeHtml(r.label)}</span>
                        </div>
                    `).join('');
                }
            }

            const referralId = referral.crd88_referraltoapid;

            // Meeting notes (stored on referral)
            const notesEl = document.getElementById('meetingNotes');
            if (notesEl) notesEl.value = (referral.crd88_meetingnotes || '');

            // Goals for this referral (stored in Goal table, linked to ReferralToAP)
            meetingGoalsState = [];
            meetingActionPlansState = {};
            meetingActiveGoalId = null;
            closeGoalActionPanel(true);
            await loadMeetingGoalsForReferral(referralId);

            // Clear modal status
            const modalStatus = document.getElementById('meetingModalStatus');
            modalStatus.className = 'status';
            modalStatus.textContent = '';

            document.getElementById('meetingModal').style.display = 'block';
        }

        function closeMeetingModal() {
            const modal = document.getElementById('meetingModal');
            if (modal) modal.style.display = 'none';
            meetingActiveStudent = null;
            meetingGoalsState = [];
            meetingActionPlansState = {};
            meetingActiveGoalId = null;
            closeGoalActionPanel(true);
        }

        function toDateInputValue(isoString) {
            // Dataverse stores ISO like 2000-11-26T00:00:00Z
            const d = new Date(isoString);
            if (Number.isNaN(d.getTime())) return '';
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // ============================================================================
        // MEETING MODAL - Goals + Action Plans (Goal-first flow)
        // ============================================================================
        function renderMeetingGoalsTable() {
            const body = document.getElementById('meetingGoalsTableBody');
            if (!body) return;

            if (!Array.isArray(meetingGoalsState) || meetingGoalsState.length === 0) {
                body.innerHTML = `
                    <div class="goals-row goals-row-empty">
                        <div style="grid-column: 1 / -1; color: var(--colorNeutralForeground2); font-size: var(--fontSizeSmall);">
                            No goals yet. Click <strong>+</strong> to add one.
                        </div>
                    </div>
                `;
                return;
            }

            body.innerHTML = meetingGoalsState.map((g, idx) => {
                const inputId = `meeting-goal-${idx}`;
                return `
                    <div class="goals-row">
                        <div>
                            <input
                                id="${inputId}"
                                class="form-control"
                                type="text"
                                value="${escapeHtml(g?.text || '')}"
                                placeholder="Type a goal..."
                                oninput="meetingGoalsState[${idx}].text=this.value"
                                onblur="saveMeetingGoalByIndex(${idx})"
                                onkeydown="if(event.key==='Enter'){ event.preventDefault(); this.blur(); }"
                            />
                        </div>
                        <div style="display:flex; justify-content:flex-end;">
                            <button
                                class="icon-btn"
                                type="button"
                                onclick="openGoalActionPanelByIndex(${idx})"
                                aria-label="Open action plans"
                                title="Open action plans"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function openGoalActionPanelByIndex(index) {
            const g = meetingGoalsState?.[index];
            if (!g) return;

            // Ensure the goal exists first (createGoal), then open action plans
            if (!g.id) {
                await saveMeetingGoalByIndex(index);
            }
            const goalId = meetingGoalsState?.[index]?.id;
            if (!goalId) return;
            await openGoalActionPanel(String(goalId));
        }

        function addMeetingGoalRow() {
            if (!Array.isArray(meetingGoalsState)) meetingGoalsState = [];
            meetingGoalsState.push({ id: null, text: '' });
            renderMeetingGoalsTable();

            // focus new row
            setTimeout(() => {
                const el = document.getElementById(`meeting-goal-${meetingGoalsState.length - 1}`);
                if (el) el.focus();
            }, 0);
        }

        async function loadMeetingGoalsForReferral(referralId) {
            const body = document.getElementById('meetingGoalsTableBody');
            if (body) {
                body.innerHTML = `
                    <div class="goals-row goals-row-empty">
                        <div style="grid-column: 1 / -1; color: var(--colorNeutralForeground2); font-size: var(--fontSizeSmall);">Loading goals</div>
                    </div>
                `;
            }

            if (!referralId) {
                meetingGoalsState = [];
                renderMeetingGoalsTable();
                return;
            }

            try {
                const res = await apiCall(REFERRAL_API_BASE_URL, `listGoalsByReferral&referralId=${encodeURIComponent(referralId)}`);
                const goals = res?.goalsNormalized || [];
                meetingGoalsState = Array.isArray(goals)
                    ? goals.map(g => ({ id: g.id || null, text: (g.text || '').toString() }))
                    : [];
            } catch (_) {
                meetingGoalsState = [];
            }

            renderMeetingGoalsTable();
        }

        async function saveMeetingGoalByIndex(index) {
            const referralId = meetingActiveStudent?.referral?.crd88_referraltoapid;
            const g = meetingGoalsState?.[index];
            if (!g || !referralId) return;

            const text = (g.text || '').toString().trim();
            if (!text) return;

            try {
                if (!g.id) {
                    const res = await apiCall(REFERRAL_API_BASE_URL, 'createGoal', 'POST', { referralId, text });
                    const goalId = res?.goalId || null;
                    if (goalId) meetingGoalsState[index].id = goalId;
                } else {
                    await apiCall(REFERRAL_API_BASE_URL, 'updateGoal', 'POST', { goalId: g.id, text });
                }
            } catch (e) {
                const modalStatus = document.getElementById('meetingModalStatus');
                if (modalStatus) {
                    modalStatus.textContent = `Error saving goal: ${e.message}`;
                    modalStatus.className = 'status error';
                }
            }

            renderMeetingGoalsTable();
        }

        function closeGoalActionPanel(silent = false) {
            const panel = document.getElementById('meetingGoalActionPanel');
            if (panel) {
                panel.classList.remove('open');
                panel.setAttribute('aria-hidden', 'true');
            }
            meetingActiveGoalId = null;
            const title = document.getElementById('meetingActiveGoalTitle');
            if (title) title.textContent = '';

            if (!silent) {
                renderMeetingGoalsTable();
            }
        }

        async function openGoalActionPanel(goalId) {
            if (!goalId) return;
            meetingActiveGoalId = goalId;

            const goal = (meetingGoalsState || []).find(g => String(g.id) === String(goalId));
            const title = document.getElementById('meetingActiveGoalTitle');
            if (title) title.textContent = (goal?.text || '').toString().trim() || '';

            const panel = document.getElementById('meetingGoalActionPanel');
            if (panel) {
                panel.classList.add('open');
                panel.setAttribute('aria-hidden', 'false');
            }

            if (!meetingActionPlansState[goalId]) {
                meetingActionPlansState[goalId] = [];
                try {
                    const res = await apiCall(REFERRAL_API_BASE_URL, `listActionPlansByGoal&goalId=${encodeURIComponent(goalId)}`);
                    const aps = res?.actionPlansNormalized || [];
                    meetingActionPlansState[goalId] = Array.isArray(aps) ? aps.map(a => ({
                        id: a.id || null,
                        actionPlanDetails: (a.actionPlanDetails || '').toString(),
                        actionBy: (a.actionBy || '').toString(),
                        reviewDate: a.reviewDate || null,
                        status: (a.status ?? 5),
                    })) : [];
                } catch (_) {
                    meetingActionPlansState[goalId] = [];
                }
            }

            // If none exist, start a new draft row immediately (matches "press > to create an action plan")
            if ((meetingActionPlansState[goalId] || []).length === 0) {
                meetingActionPlansState[goalId].push({
                    id: null,
                    actionPlanDetails: '',
                    actionBy: '',
                    reviewDate: null,
                    status: 5
                });
            }

            renderMeetingActionPlansTable();
        }

        function renderMeetingActionPlansTable() {
            const goalId = meetingActiveGoalId;
            const body = document.getElementById('meetingActionPlansTableBody');
            if (!body) return;

            const rows = meetingActionPlansState?.[goalId] || [];
            if (!goalId) {
                body.innerHTML = '';
                return;
            }
            if (!rows.length) {
                body.innerHTML = `
                    <div class="ap-row ap-row-empty">
                        <div style="grid-column: 1 / -1; color: var(--colorNeutralForeground2); font-size: var(--fontSizeSmall);">
                            No action plans yet. Click <strong>+</strong> to add one.
                        </div>
                    </div>
                `;
                return;
            }

            body.innerHTML = rows.map((ap, idx) => {
                const dateVal = ap?.reviewDate ? toDateInputValue(ap.reviewDate) : '';
                const statusVal = (ap?.status ?? 5);
                const canSave = !!(ap?.id || (ap?.actionPlanDetails || '').toString().trim());
                const saveType = ap?.__saveStatusType || '';
                const saveMsg = (ap?.__saveStatusMsg || '').toString();
                return `
                    <div class="ap-row">
                        <div class="ap-detail">
                            <textarea class="form-control" rows="3"
                                      placeholder="Action plan detail..."
                                      oninput="meetingActionPlansState['${goalId}'][${idx}].actionPlanDetails=this.value; meetingActionPlansState['${goalId}'][${idx}].__saveStatusType=''; meetingActionPlansState['${goalId}'][${idx}].__saveStatusMsg='';"
                                      onblur="saveMeetingActionPlanRow(${idx})"
                            >${escapeHtml(ap?.actionPlanDetails || '')}</textarea>
                        </div>
                        <div>
                            <label style="display:block; font-size: var(--fontSizeSmall); color: var(--colorNeutralForeground2); margin-bottom: 6px;">Action by</label>
                            <input class="form-control" type="text" value="${escapeHtml(ap?.actionBy || '')}"
                                   placeholder="Who is responsible?"
                                   oninput="meetingActionPlansState['${goalId}'][${idx}].actionBy=this.value; meetingActionPlansState['${goalId}'][${idx}].__saveStatusType=''; meetingActionPlansState['${goalId}'][${idx}].__saveStatusMsg='';"
                                   onblur="saveMeetingActionPlanRow(${idx})" />
                        </div>
                        <div>
                            <label style="display:block; font-size: var(--fontSizeSmall); color: var(--colorNeutralForeground2); margin-bottom: 6px;">Next Review Date</label>
                            <input class="form-control" type="date" value="${escapeHtml(dateVal)}"
                                   onchange="onMeetingActionPlanDateChange(${idx}, this.value)" />
                        </div>
                        <div>
                            <label style="display:block; font-size: var(--fontSizeSmall); color: var(--colorNeutralForeground2); margin-bottom: 6px;">Review Status</label>
                            <div style="display:flex; gap: 8px; align-items:center;">
                                <select class="form-control" style="flex: 1;" onchange="onMeetingActionPlanStatusChange(${idx}, this.value)">
                                    <option value="5" ${String(statusVal) === '5' ? 'selected' : ''}>In Progress</option>
                                    <option value="7" ${String(statusVal) === '7' ? 'selected' : ''}>Completed</option>
                                </select>
                                <button
                                    class="btn btn-primary"
                                    type="button"
                                    style="padding: 10px 14px; border-radius: 10px; height: 42px; white-space: nowrap;"
                                    ${canSave ? '' : 'disabled'}
                                    onclick="saveMeetingActionPlanRow(${idx})"
                                >Save</button>
                            </div>
                            ${saveMsg ? `
                                <div style="margin-top: 6px; font-size: var(--fontSizeSmall); color: ${
                                    saveType === 'success'
                                        ? 'var(--colorPaletteGreenForeground1)'
                                        : (saveType === 'error' ? 'var(--colorPaletteRedForeground1)' : 'var(--colorNeutralForeground2)')
                                };">
                                    ${escapeHtml(saveMsg)}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addMeetingActionPlanRow() {
            const goalId = meetingActiveGoalId;
            if (!goalId) return;
            if (!meetingActionPlansState[goalId]) meetingActionPlansState[goalId] = [];
            meetingActionPlansState[goalId].push({
                id: null,
                actionPlanDetails: '',
                actionBy: '',
                reviewDate: null,
                status: 5
            });
            renderMeetingActionPlansTable();
        }

        function onMeetingActionPlanDateChange(index, dateValue) {
            const goalId = meetingActiveGoalId;
            if (!goalId) return;
            const ap = meetingActionPlansState?.[goalId]?.[index];
            if (!ap) return;

            ap.reviewDate = dateValue
                ? new Date(dateValue + 'T00:00:00Z').toISOString()
                : null;
            ap.__saveStatusType = '';
            ap.__saveStatusMsg = '';
            saveMeetingActionPlanRow(index);
        }

        function onMeetingActionPlanStatusChange(index, statusValue) {
            const goalId = meetingActiveGoalId;
            if (!goalId) return;
            const ap = meetingActionPlansState?.[goalId]?.[index];
            if (!ap) return;

            ap.status = Number(statusValue);
            ap.__saveStatusType = '';
            ap.__saveStatusMsg = '';
            saveMeetingActionPlanRow(index);
        }

        async function saveMeetingActionPlanRow(index) {
            const goalId = meetingActiveGoalId;
            const referralId = meetingActiveStudent?.referral?.crd88_referraltoapid;
            if (!goalId || !referralId) return;

            const ap = meetingActionPlansState?.[goalId]?.[index];
            if (!ap) return;

            const payload = {
                goalId,
                referralId,
                actionPlanId: ap.id || null,
                actionPlanDetails: (ap.actionPlanDetails || '').toString().trim(),
                actionBy: (ap.actionBy || '').toString().trim(),
                reviewDate: ap.reviewDate || null,
                status: ap.status ?? 5
            };
            // Avoid creating empty action plans accidentally
            if (!ap.id && !payload.actionPlanDetails) return;
            if (payload.reviewDate === null) delete payload.reviewDate;
            if (payload.actionPlanId === null) delete payload.actionPlanId;

            try {
                ap.__saveStatusType = 'info';
                ap.__saveStatusMsg = 'Saving...';
                renderMeetingActionPlansTable();
                const res = await apiCall(REFERRAL_API_BASE_URL, 'upsertActionPlanForGoal', 'POST', payload);
                const apId = res?.actionPlanId || null;
                if (apId && !ap.id) {
                    meetingActionPlansState[goalId][index].id = apId;
                }
                meetingActionPlansState[goalId][index].__saveStatusType = 'success';
                meetingActionPlansState[goalId][index].__saveStatusMsg = (res?.message || 'Saved.').toString();
            } catch (e) {
                meetingActionPlansState[goalId][index].__saveStatusType = 'error';
                meetingActionPlansState[goalId][index].__saveStatusMsg = `Error: ${e.message}`;
            }

            renderMeetingActionPlansTable();
        }

        async function submitMeetingPlan() {
            const referralId = meetingActiveStudent?.referral?.crd88_referraltoapid;
            if (!referralId) return;

            const btn = document.getElementById('meetingSubmitBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const meetingNotes = (document.getElementById('meetingNotes')?.value || '');
                await apiCall(REFERRAL_API_BASE_URL, `updateCase&caseId=${encodeURIComponent(referralId)}`, 'POST', { meetingNotes });

                // Update cached referral + attached action plan meta
                const sid = meetingActiveStudent.student.new_studentsid;
                const current = meetingStudentLatestCase[sid] || meetingActiveStudent.referral;
                current.crd88_meetingnotes = meetingNotes;
                meetingStudentLatestCase[sid] = current;
                renderMeetingStudentsList();

                const modalStatus = document.getElementById('meetingModalStatus');
                modalStatus.textContent = 'Saved successfully.';
                modalStatus.className = 'status success';

                btn.textContent = 'Save Notes';
                btn.disabled = false;
            } catch (e) {
                const modalStatus = document.getElementById('meetingModalStatus');
                modalStatus.textContent = `Error saving: ${e.message}`;
                modalStatus.className = 'status error';

                btn.textContent = 'Save Notes';
                btn.disabled = false;
            }
        }

        // ============================================================================
        // STATUS MESSAGES
        // ============================================================================
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function hideStatus() {
            const status = document.getElementById('status');
            status.className = 'status';
            status.textContent = '';
        }
    </script>
</body>
</html>
